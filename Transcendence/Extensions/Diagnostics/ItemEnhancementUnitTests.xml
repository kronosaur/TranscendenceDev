<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>

	<Type unid="&unidItemEnhancementUnitTests;">
		<Events>
			<OnGlobalRunDiagnostics>
				(block (
					(runAllIterations Nil)

					(armorEnhancements
						'(&itAblativeArmorCoating; &itCarbonWeaverNanos; &itParticleResistCoating;
							&itRadiationImmuneCoating; &itEMPImmuneCoating; &itIonResistCoating;
							&itShieldInterfereCoating; &itIonEffectImmuneCoating; &itThermoResistCoating;
							&itCarbonWeaver2Coating; &itDegeneratingNanos;
							&itReactiveArmorCoating; &itReflectiveArmorCoating; &itRegeneratingNanos;
							)
						)

					(armorSegments
						'(&itLightCeramicPlate; &itLightReactiveArmor; &itUltraLightTitaniumCasing; &itUltraLightTitaniumArmor; &itLightTitaniumArmor;
							&itCeramicPlate; &itReactiveArmor; &itTitaniumArmor; &itLightXMHArmor;
							&itHeavyCeramicPlate; &itPhotorepairArmor; &itLightPlasteelPlate; &itPolymeshArmor; &itHardenedReactiveArmor; &itHeavyReactiveArmor;
							&itPlasteelPlate; &itPolyceramicPlate; &itAdvancedReactiveArmor; &itLightSolarArmor; &itLightTevlarArmor; &itV10PoweredArmor;
							&itLightBlastPlate; &itCeralloyArmor; &itHardenedPlasteelPlate; &itHeavyPlasteelPlate; &itMediumSolarArmor;
							&itBlastPlate; &itHeavyCeralloyArmor; &itDuralloyArmor; &itLightOmskArmor; &itAdvancedPlasteelPlate; &itHeavySolarArmor; &itStealthPlate;
							&itHeavyBlastPlate; &itSuperHeavyBlastPlate; &itAdvancedCeralloyArmor; &itLightGusokuArmor; &itP120HexphaseArmor; &itLightOrthoSteel;
							&itCarbideCarapace; &itMediumOmskArmor; &itP210HexphaseArmor; &itLightIthaliumArmor; &itMediumIthaliumArmor; &itMassiveIthaliumArmor; &itOrthoSteel; &itQuadroCarbideArmor; &itMassiveQuadroCarbideArmor; &itTransuranicPlate; &itV300PoweredArmor;
							&itHexaCarbideArmor; &itMassiveHexaCarbideArmor; &itMassiveOmskArmor; &itP1000HexphaseArmor; &itAdvancedIthaliumArmor; &itHeavyOrthoSteel;
							&itDiamondLatticeArmor; &itExperimentalIthaliumArmor; &itOctoCarbideArmor; &itMassiveOctoCarbideArmor;
							)
						)
					)
					;	Set up a player ship

					(setq gPlayerShip (sysCreateShip &scSapphirePlayer; Nil &svPlayer;))
					(if (not gPlayerShip)
						(error "Unable to create player ship.")
						)
					(shpOrder gPlayerShip 'hold)

					;	Unit Tests for Item Enhancements

					(diagEval (list

						;	Enhance reactive armor with ablative -----------------------------------

						{	test:'(@ (itmGetProperty 
										(@ (objGetItems gPlayerShip "aI") 0)
										'damageAdj
										)
									'particle
									)												result:100	}

						{	test:'(@ (objCanEnhanceItem 
										gPlayerShip 
										(@ (objGetItems gPlayerShip "aI") 0)
										&itAblativeArmorCoating;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "aI") 0)
										&itAblativeArmorCoating;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(@ (itmGetProperty 
										(@ (objGetItems gPlayerShip "aI") 0)
										'damageAdj
										)
									'particle
									)												result:75	}

						;	Enhance harderned reactive armor with anti-radiation -------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itHardenedReactiveArmor; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(itmCreate &itHardenedReactiveArmor; 1)
										&itRadiationImmuneCoating;
										)
									'resultCode
									)												result:'alreadyEnhanced	}

						{	test:'(enum (objGetItems gPlayerShip "aU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Silicarb Field Crystal -------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itNephrenP25; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itSilicarbCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(itmGetProperty 
										(@ (objGetItems gPlayerShip "sU") 0)
										'hp
										)											result:'110	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itSilicarbCrystal;
										)
									'resultCode
									)												result:'improved	}

						{	test:'(itmGetProperty 
										(@ (objGetItems gPlayerShip "sU") 0)
										'hp
										)											result:'120	}

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itMammoth25Deflector; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(itmCreate &itMammoth25Deflector; 1)
										&itSilicarbCrystal;
										)
									'resultCode
									)												result:'noEffect	}

						{	test:'(enum (objGetItems gPlayerShip "sU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Rubidium Field Crystal -------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itClass1Deflector; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itRubidiumCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(@ (objGetItemProperty
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										'damageAdj
										)
									'particle
									)												result:60	}

						{	test:'(enum (objGetItems gPlayerShip "sU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Green Etherium Field Crystal -------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itClass3Deflector; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itGreenEtheriumCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(objGetItemProperty
									gPlayerShip
									(@ (objGetItems gPlayerShip "sU") 0)
									'reflect
									)												result:{ particle:95 }	}

						{	test:'(enum (objGetItems gPlayerShip "sU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Diamond Field Crystal -------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itNephrenP25; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itDiamondCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(itmGetProperty 
										(@ (objGetItems gPlayerShip "sU") 0)
										'hp
										)											result:'110	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itDiamondCrystal;
										)
									'resultCode
									)												result:'improved	}

						{	test:'(itmGetProperty 
										(@ (objGetItems gPlayerShip "sU") 0)
										'hp
										)											result:'120	}

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itMammoth25Deflector; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(itmCreate &itMammoth25Deflector; 1)
										&itDiamondCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(enum (objGetItems gPlayerShip "sU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Trillum Field Crystal -------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itClass3Deflector; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itTrillumCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(objGetItemProperty
									gPlayerShip
									(@ (objGetItems gPlayerShip "sU") 0)
									'powerUse
									)												result:8000	}

						{	test:'(enum (objGetItems gPlayerShip "sU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Decayed Etherium Field Crystal -------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itClass3Deflector; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itDecayedEtheriumCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(objGetItemProperty
									gPlayerShip
									(@ (objGetItems gPlayerShip "sU") 0)
									'absorbAdj
									)												result:{ ion:10 }	}

						{	test:'(enum (objGetItems gPlayerShip "sU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Molbidium Crystal -------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itNephrenP25; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itMolbidiumCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(itmGetProperty 
										(@ (objGetItems gPlayerShip "sU") 0)
										'hp
										)											result:'130	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itMolbidiumCrystal;
										)
									'resultCode
									)												result:'alreadyEnhanced	}

						{	test:'(itmGetProperty 
										(@ (objGetItems gPlayerShip "sU") 0)
										'hp
										)											result:'130	}

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itMammoth25Deflector; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(itmCreate &itMammoth25Deflector; 1)
										&itMolbidiumCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(enum (objGetItems gPlayerShip "sU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Superlattice Field Crystal -------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itClass3Deflector; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itSuperlatticeCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(@ (objGetItemProperty
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										'damageAdj
										)
									'ion
									)												result:60	}

						{	test:'(enum (objGetItems gPlayerShip "sU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Blue Etherium Field Crystal -------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itMammoth100Deflector; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itBlueEtheriumCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(objGetItemProperty
									gPlayerShip
									(@ (objGetItems gPlayerShip "sU") 0)
									'reflect
									)												result:{ ion:95 }	}

						{	test:'(enum (objGetItems gPlayerShip "sU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Yellow Etherium Field Crystal -------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itMammoth100Deflector; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "sU") 0)
										&itYellowEtheriumCrystal;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(objGetItemProperty
									gPlayerShip
									(@ (objGetItems gPlayerShip "sU") 0)
									'reflect
									)												result:{ positron:95 }	}

						{	test:'(enum (objGetItems gPlayerShip "sU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Defective Weapon -------------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itLaserCannon; 1)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "wU") 0)
										&itDamageWeaponROM;
										)
									'resultCode
									)												result:'damaged	}

						{	test:'(objGetItemProperty
									gPlayerShip
									(@ (objGetItems gPlayerShip "wU") 0)
									'disrupted
									)												result:9000	}

						{	test:'(enum (objGetItems gPlayerShip "wU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Weapon Optimizer ROM ---------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itLaserCannon; 1)
									)												result:'ignore	}

						{	test:'(objGetItemProperty
									gPlayerShip
									(@ (objGetItems gPlayerShip "wU") 0)
									'fireDelay
									)												result:5	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "wU") 0)
										&itWeaponSpeedROM;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(objGetItemProperty
									gPlayerShip
									(@ (objGetItems gPlayerShip "wU") 0)
									'fireDelay
									)												result:4	}

						{	test:'(enum (objGetItems gPlayerShip "wU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Weapon Efficiency ROM --------------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmCreate &itLaserCannon; 1)
									)												result:'ignore	}

						{	test:'(objGetItemProperty
									gPlayerShip
									(@ (objGetItems gPlayerShip "wU") 0)
									'powerUse
									)												result:1000	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "wU") 0)
										&itWeaponEfficiencyROM;
										)
									'resultCode
									)												result:'ok	}

						{	test:'(objGetItemProperty
									gPlayerShip
									(@ (objGetItems gPlayerShip "wU") 0)
									'powerUse
									)												result:800	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "wU") 0)
										&itWeaponEfficiencyROM;
										)
									'resultCode
									)												result:'alreadyEnhanced	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(@ (objGetItems gPlayerShip "wU") 0)
										&itWeaponSpeedROM;
										)
									'resultCode
									)												result:'cantReplaceEnhancement	}

						{	test:'(enum (objGetItems gPlayerShip "wU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Longzhu sphere: repair shields -----------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmSetProperty
										(itmCreate &itClass1Deflector; 1)
										'damaged True
										)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(itmSetProperty
											(itmCreate &itClass1Deflector; 1)
											'damaged True
											)
										&itLongzhuSphere;
										)
									'resultCode
									)												result:'repaired	}

						{	test:'(objGetItems gPlayerShip "dDU")					result:Nil	}

						{	test:'(enum (objGetItems gPlayerShip "dU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Longzhu sphere: repair weapon -----------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmSetProperty
										(itmCreate &itLaserCannon; 1)
										'damaged True
										)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(itmSetProperty
											(itmCreate &itLaserCannon; 1)
											'damaged True
											)
										&itLongzhuSphere;
										)
									'resultCode
									)												result:'repaired	}

						{	test:'(objGetItems gPlayerShip "dDU")					result:Nil	}

						{	test:'(enum (objGetItems gPlayerShip "dU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}

						;	Longzhu sphere: repair drive -------------------------------------------

						{	test:'(objAddItem gPlayerShip 
									(itmSetProperty
										(itmCreate &itTritiumPropulsionUpgrade; 1)
										'damaged True
										)
									)												result:'ignore	}

						{	test:'(@ (objEnhanceItem 
										gPlayerShip
										(itmSetProperty
											(itmCreate &itTritiumPropulsionUpgrade; 1)
											'damaged True
											)
										&itLongzhuSphere;
										)
									'resultCode
									)												result:'repaired	}

						{	test:'(objGetItems gPlayerShip "dDU")					result:Nil	}

						{	test:'(enum (objGetItems gPlayerShip "dU") theItem 
									(objRemoveItem gPlayerShip theItem)
									)												result:'ignore	}
						))

					;	Armor paste iterations

					(if runAllIterations
						(enum armorEnhancements theEnhancement
							(block (
								(enhancementItem (itmCreate theEnhancement 1))
								)
								(enum armorSegments theArmor
									(block (
										(armorItem (itmCreate theArmor 1))
										result
										)
										(objAddItem gPlayerShip armorItem)
										(setq result (objEnhanceItem gPlayerShip armorItem enhancementItem))
					
										(print (itmGetName enhancementItem 'short) " + " (itmGetName armorItem 'short) ": "
											(join 
												(list
													(itmTranslate theEnhancement 'descResultIntro)
													(or (@ result 'desc)
														(itmTranslate theEnhancement (cat "descResult." (@ result 'resultCode)))
														)
													)
												" "
												)
											)
										)
									)
								)
							)
						)

					;	Done

					(objDestroy gPlayerShip)
					(setq gPlayerShip Nil)
					)
			</OnGlobalRunDiagnostics>
		</Events>
	</Type>


</TranscendenceModule>
