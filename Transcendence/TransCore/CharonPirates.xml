<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>

	<Sovereign UNID="&svPirates;"
			name=":the Charon confederacy"
			shortName=": Charon pirates"
			adjective="Charon"
			demonym=":a Charon pirate(s)"
			plural="true"

			alignment="destructive order"
			/>

<!-- ENCOUNTERS -->

	<!-- Charon Pirate Cache -->

	<StationType UNID="&stCharonPirateOutpost;"
			name=				"Charon Pirates cache"
			sovereign=			"&svPirates;"
			abandonedScreen=	"&dsRPGAbandonedStation;"
			dockingPorts=		"8"

			armorID=			"&itUltraLightTitaniumArmor;"
			hitPoints=			"70"
			regen=				"1"
			fireRateAdj=		"80"
			explosionType=		"&vtKineticExplosion1;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"charonPirates, enemy, envAir, envEarth, envFire, envWater, generic, human, pirates, populated"
			>

		<!-- Encounter Info -->

		<Encounter
				systemCriteria=			"+outlawSpace;"
				systemAffinity=			"*"
				levelFrequency=			"cuv-- ----- ----- ----- -----"

				locationCriteria=		"+asteroids"
				enemyExclusionRadius=	"50"
				/>

		<Image			imageID="&rsStations1;" imageX="0" imageY="512" imageWidth="156" imageHeight="156"/>

		<Devices>
			<Device deviceID="&itLaserCannon;"	omnidirectional="true"/>
		</Devices>

		<Ships>
			<Table>
				<Ship chance="85"	count="1d4"	class="&scCorsair;"		orders="guard"/>
				<Group chance="10">
					<Ship			count="1"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1"	class="&scViking;"		orders="guard"/>
				</Group>
				<Ship chance="5"	count="1d2"	class="&scViking;"		orders="guard"/>
			</Table>
		</Ships>

		<Items>
			<Lookup chance="50" table="&trStdLevelTreasure;"/>
		</Items>

		<Encounters frequency="common">
			<Table>
				<Ship chance="75" count="1"		class="&scCorsair;" eventHandler="&evStdPatrolEncounterBehavior;">
					<Escorts>
						<Ship count="1d3" class="&scCorsair;" orders="escort"/>
					</Escorts>
				</Ship>
				<Ship chance="25" count="1"		class="&scViking;" eventHandler="&evStdPatrolEncounterBehavior;"/>
			</Table>
		</Encounters>
	</StationType>

	<!-- Charon Pirate Outpost II -->

	<StationType UNID="&stCharonPirateOutpost2;"
			name=				"Charon Pirates outpost"
			sovereign=			"&svPirates;"
			abandonedScreen=	"&dsRPGAbandonedStation;"
			dockingPorts=		"8"

			armorID=			"&itReactiveArmor;"
			hitPoints=			"90"
			regen=				"1"
			fireRateAdj=		"50"
			explosionType=		"&vtKineticExplosion2;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"charonPirates, enemy, envAir, envEarth, envFire, envWater, generic, human, pirates, populated"
			>

		<!-- Encounter Info -->

		<Encounter
				systemCriteria=			"+outlawSpace;"
				systemAffinity=			"*"
				levelFrequency=			"-cuv- ----- ----- ----- -----"

				locationCriteria=		"+asteroids"
				enemyExclusionRadius=	"50"
				/>

		<Image			imageID="&rsStations1;" imageX="0" imageY="512" imageWidth="156" imageHeight="156"/>

		<Devices>
			<Device deviceID="&itTurbolaserCannon;"	omnidirectional="true"/>
		</Devices>

		<Ships>
			<Table>
				<Ship chance="35"	count="2d4"	class="&scCorsair;"		orders="guard"/>
				<Group chance="30">
					<Ship			count="1d4+1"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1"	class="&scViking;"		orders="guard"/>
				</Group>
				<Ship chance="15"	count="1d2"	class="&scCorsair-II;"	orders="guard"/>
				<Group chance="10">
					<Ship			count="1d3"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1"	class="&scCorsair-II;"	orders="guard"/>
				</Group>
				<Ship chance="10"	count="1d4"	class="&scViking;"		orders="guard"/>
			</Table>
		</Ships>

		<Items value="standard:level=2">
			<Item	count="2d8"	item="&itKM100Missile;" />
			<Lookup				table="&trStdTreasure;"/>
		</Items>

		<Encounters frequency="common">
			<Table>
				<Ship chance="50" count="1"	class="&scCorsair;" eventHandler="&evStdPatrolEncounterBehavior;">
					<Escorts>
						<Ship count="1d4" class="&scCorsair;" orders="escort"/>
					</Escorts>
				</Ship>
				<Ship chance="50" count="1"	class="&scViking;" eventHandler="&evStdPatrolEncounterBehavior;">
					<Escorts>
						<Table>
							<Null chance="50"/>
							<Ship chance="50" count="1d3" class="&scCorsair;" orders="escort"/>
						</Table>
					</Escorts>
				</Ship>
			</Table>
		</Encounters>

	</StationType>

	<!-- Charon Pirate Outpost IIa -->

	<StationType UNID="&stCharonPirateOutpost2a;"
			name=				"Charon Pirates outpost"
			sovereign=			"&svPirates;"
			abandonedScreen=	"&dsRPGAbandonedStation;"
			dockingPorts=		"8"

			armorID=			"&itReactiveArmor;"
			hitPoints=			"50"
			regen=				"1"
			fireRateAdj=		"60"
			explosionType=		"&vtKineticExplosion1;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"charonPirates, enemy, envAir, envEarth, envFire, envWater, human, pirates, populated"
			>

		<!-- Encounter Info -->

		<Encounter
				systemCriteria=			"+outlawSpace;"
				systemAffinity=			"*"
				levelFrequency=			"r---- ----- ----- ----- -----"

				locationCriteria=		"+asteroids"
				enemyExclusionRadius=	"50"
				/>

		<Image			imageID="&rsStations1;" imageX="0" imageY="512" imageWidth="156" imageHeight="156"/>

		<Devices>
			<Device deviceID="&itTurbolaserCannon;"	omnidirectional="true"/>
		</Devices>

		<Ships>
			<Table>
				<Ship chance="45"	count="2d3"	class="&scCorsair;"		orders="guard"/>
				<Group chance="40">
					<Ship			count="1d4"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1"	class="&scViking;"		orders="guard"/>
				</Group>
				<Ship chance="15"	count="1d4"	class="&scViking;"		orders="guard"/>
			</Table>
		</Ships>

		<Items value="standard:level=1">
			<Lookup	table="&trStdTreasure;"/>
		</Items>

		<Encounters frequency="common">
			<Table>
				<Ship chance="50" count="1"	class="&scCorsair;" eventHandler="&evStdPatrolEncounterBehavior;">
					<Escorts>
						<Ship count="1d4" class="&scCorsair;" orders="escort"/>
					</Escorts>
				</Ship>
				<Ship chance="50" count="1"	class="&scViking;" eventHandler="&evStdPatrolEncounterBehavior;">
					<Escorts>
						<Table>
							<Ship chance="50" count="1d3" class="&scCorsair;" orders="escort"/>
							<Null chance="50"/>
						</Table>
					</Escorts>
				</Ship>
			</Table>
		</Encounters>

	</StationType>

	<!-- Charon Pirate Outpost III -->

	<StationType UNID="&stCharonPirateOutpost3;"
			name=				"Charon Pirates stronghold"
			sovereign=			"&svPirates;"
			abandonedScreen=	"&dsRPGAbandonedStation;"
			dockingPorts=		"8"

			multiHull=			"true"
			armorID=			"&itHeavyReactiveArmor;"
			hitPoints=			"200"
			regen=              "5"
			fireRateAdj=		"40"
			explosionType=		"&vtKineticExplosion3;"
			ejectaType=			"&vtWreckEjecta;"

			alertWhenDestroyed=	"30"

			attributes=			"charonPirates, enemy, envAir, envEarth, envFire, envWater, generic, human, majorStation, pirates, populated"
			>

		<!-- Encounter Info -->

		<Encounter
				systemCriteria=			"+outlawSpace;"
				systemAffinity=			"*"
				levelFrequency=			"-rcr- ----- ----- ----- -----"

				locationCriteria=		"+asteroids"
				enemyExclusionRadius=	"50"
				/>

		<Image			imageID="&rsStations2;" imageX="0" imageY="768" imageWidth="180" imageHeight="180"/>

		<Devices>
			<Device deviceID="&itTurbolaserCannon;"	omnidirectional="true" posAngle="45"  posRadius="60"/>
			<Device deviceID="&itTurbolaserCannon;"	omnidirectional="true" posAngle="215" posRadius="60"/>
		</Devices>

		<Ships>
			<!-- Docked -->

			<Table>
				<Ship chance="10"	count="2d3"	class="&scViking;"		orders="guard"/>
				<Group chance="30">
					<Ship			count="1d6"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1d2"	class="&scCorsair-II;"	orders="guard"/>
				</Group>
				<Group chance="20">
					<Ship			count="1d4"	class="&scViking;"		orders="guard"/>
					<Ship			count="1"	class="&scCorsair-II;"	orders="guard"/>
				</Group>
				<Group chance="15">
					<Ship			count="1d2"	class="&scViking;"		orders="guard"/>
					<Ship			count="1"	class="&scDrake;"		orders="guard"/>
				</Group>
				<Group chance="15">
					<Ship			count="1d6"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1"	class="&scDrake;"		orders="guard"/>
				</Group>
				<Ship chance="10"	count="1d4"	class="&scCorsair-II;"	orders="guard"/>
			</Table>

			<!-- Patrol -->

			<Table>
				<Group chance="75">
					<Ship			count="1d6" class="&scViking;"		orders="patrol" patrolDist="15"/>
					<Ship			count="1d2" class="&scCorsair-II;"	orders="patrol" patrolDist="15"/>
				</Group>
				<Ship chance="25"	count="1"	class="&scCharonFrigateRaider;" eventHandler="&evCharonRaiderBehavior;"/>
			</Table>
		</Ships>

		<Reinforcements minShips="6">
			<Table>
				<Ship chance="35"	count="1d6"	class="&scCorsair;"		orders="guard"/>
				<Ship chance="35"	count="1d3"	class="&scViking;"		orders="guard"/>
				<Ship chance="20"	count="1d2"	class="&scCorsair-II;"	orders="guard"/>
				<Ship chance="10"	count="1"	class="&scDrake;"		orders="guard"/>
			</Table>
		</Reinforcements>

		<Items value="standard:level=3:x=2.5">
			<Item	count="2d8"	item="&itKM100Missile;" />
			<Lookup				table="&trStdTreasure;"/>
		</Items>

		<Encounters frequency="common">
			<Table>
				<Ship chance="60" count="1"	class="&scViking;" eventHandler="&evStdPatrolEncounterBehavior;">
					<Escorts>
						<Table>
							<Ship chance="40" count="1d6" class="&scCorsair;" orders="escort"/>
							<Ship chance="30" count="1" class="&scViking;" orders="escort"/>
							<Ship chance="30" count="1" class="&scCorsair-II;" orders="escort"/>
						</Table>
					</Escorts>
				</Ship>
				<Ship chance="30" count="1"	class="&scCorsair-II;" eventHandler="&evStdPatrolEncounterBehavior;">
					<Escorts>
						<Ship chance="60" count="1d6" class="&scCorsair;" orders="escort"/>
						<Ship chance="40" count="1" class="&scViking;" orders="escort"/>
					</Escorts>
				</Ship>
				<Ship chance="10" count="1"	class="&scCharonFrigateRaider;" eventHandler="&evCharonRaiderBehavior;"/>
			</Table>
		</Encounters>

		<DockingPorts>
			<Port x="51"	y="80" />
			<Port x="91"	y="42" />
			<Port x="101"	y="-54" />
			<Port x="61"	y="-90" />
			<Port x="-61"	y="-90" />
			<Port x="-101"	y="-54" />
			<Port x="-91"	y="42" />
			<Port x="-51"	y="80" />
		</DockingPorts>

	</StationType>

	<!-- Charon Primary Stronghold 1 -->

	<StationType UNID="&stCharonPrimaryStronghold1;"
			name=				"Charon Pirates stronghold"
			sovereign=			"&svPirates;"
			abandonedScreen=	"&dsRPGAbandonedStation;"
			dockingPorts=		"8"

			multiHull=			"true"
			armorID=			"&itReactiveArmor;"
			hitPoints=			"100"
			regen=				"3"
			fireRateAdj=		"40"
			explosionType=		"&vtKineticExplosion3;"
			ejectaType=			"&vtWreckEjecta;"

			attributes=			"charonPirates, enemy, human, majorStation, pirates, populated, primaryStronghold, uncharted"
			>

		<Image			imageID="&rsStations2;" imageX="0" imageY="768" imageWidth="180" imageHeight="180"/>

		<Devices>
			<Device deviceID="&itTurbolaserCannon;"	omnidirectional="true"/>
		</Devices>

		<Ships>
			<!-- Docked -->

			<Table>
				<Ship chance="35"	count="2d3"	class="&scCorsair;"		orders="guard"/>
				<Group chance="30">
					<Ship			count="1d4"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1"	class="&scViking;"		orders="guard"/>
				</Group>
				<Ship chance="15"	count="1d2"	class="&scCorsair-II;"	orders="guard"/>
				<Group chance="10">
					<Ship			count="1d2"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1"	class="&scCorsair-II;"	orders="guard"/>
				</Group>
				<Ship chance="10"	count="1d4"	class="&scViking;"		orders="guard"/>
			</Table>

			<!-- Patrol -->

			<Table>
				<Group chance="75">
					<Ship			count="1d4" class="&scCorsair;"		orders="patrol" patrolDist="15"/>
					<Ship			count="1d2" class="&scViking;"		orders="patrol" patrolDist="15"/>
				</Group>
				<Ship chance="25"	count="1"	class="&scCorsair-II;"	orders="patrol" patrolDist="20">
					<Escorts>
						<Ship			count="1d6"	class="&scCorsair;"	orders="escort"/>
					</Escorts>
				</Ship>
			</Table>
		</Ships>

		<Items value="standard">
			<Item	count="2d8"	item="&itKM100Missile;" />
			<Lookup				table="&trStdLevelTreasure;"/>
		</Items>

		<DockingPorts>
			<Port x="51"	y="80" />
			<Port x="91"	y="42" />
			<Port x="101"	y="-54" />
			<Port x="61"	y="-90" />
			<Port x="-61"	y="-90" />
			<Port x="-101"	y="-54" />
			<Port x="-91"	y="42" />
			<Port x="-51"	y="80" />
		</DockingPorts>

	</StationType>

	<!-- Charon Primary Stronghold 2 -->

	<StationType UNID="&stCharonPrimaryStronghold2;"
			name=				"Charon Pirates stronghold"
			sovereign=			"&svPirates;"
			abandonedScreen=	"&dsRPGAbandonedStation;"
			dockingPorts=		"8"

			multiHull=			"true"
			armorID=			"&itHeavyReactiveArmor;"
			hitPoints=			"150"
			regen=				"4"
			fireRateAdj=		"40"
			explosionType=		"&vtKineticExplosion3;"
			ejectaType=			"&vtWreckEjecta;"

			alertWhenDestroyed=	"30"

			attributes=			"charonPirates, enemy, human, majorStation, pirates, populated, primaryStronghold, uncharted"
			>

		<Image			imageID="&rsStations2;" imageX="0" imageY="768" imageWidth="180" imageHeight="180"/>

		<Devices>
			<Device deviceID="&itTurbolaserCannon;"	omnidirectional="true" posAngle="45"  posRadius="60"/>
			<Device deviceID="&itTurbolaserCannon;"	omnidirectional="true" posAngle="215" posRadius="60"/>
		</Devices>

		<Ships>
			<!-- Docked -->

			<Table>
				<Ship chance="10"	count="2d3"	class="&scViking;"		orders="guard"/>
				<Group chance="30">
					<Ship			count="1d6"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1d2"	class="&scCorsair-II;"	orders="guard"/>
				</Group>
				<Group chance="20">
					<Ship			count="1d4"	class="&scViking;"		orders="guard"/>
					<Ship			count="1"	class="&scCorsair-II;"	orders="guard"/>
				</Group>
				<Group chance="15">
					<Ship			count="1d2"	class="&scViking;"		orders="guard"/>
					<Ship			count="1"	class="&scDrake;"		orders="guard"/>
				</Group>
				<Group chance="15">
					<Ship			count="1d6"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1"	class="&scDrake;"		orders="guard"/>
				</Group>
				<Ship chance="10"	count="1d4"	class="&scCorsair-II;"	orders="guard"/>
			</Table>

			<!-- Patrol -->

			<Table>
				<Group chance="75">
					<Ship			count="1d6" class="&scViking;"		orders="patrol" patrolDist="15"/>
					<Ship			count="1d2" class="&scCorsair-II;"	orders="patrol" patrolDist="15"/>
				</Group>
				<Ship chance="25"	count="1"	class="&scCharonFrigateRaider;" eventHandler="&evCharonRaiderBehavior;"/>
			</Table>
		</Ships>

		<Reinforcements minShips="6">
			<Table>
				<Ship chance="35"	count="1d6"	class="&scCorsair;"		orders="guard"/>
				<Ship chance="35"	count="1d3"	class="&scViking;"		orders="guard"/>
				<Ship chance="20"	count="1d2"	class="&scCorsair-II;"	orders="guard"/>
				<Ship chance="10"	count="1"	class="&scDrake;"		orders="guard"/>
			</Table>
		</Reinforcements>

		<Items value="standard">
			<Item	count="2d8"	item="&itKM100Missile;" />
			<Lookup				table="&trStdLevelTreasure;"/>
		</Items>

		<DockingPorts>
			<Port x="51"	y="80" />
			<Port x="91"	y="42" />
			<Port x="101"	y="-54" />
			<Port x="61"	y="-90" />
			<Port x="-61"	y="-90" />
			<Port x="-101"	y="-54" />
			<Port x="-91"	y="42" />
			<Port x="-51"	y="80" />
		</DockingPorts>

	</StationType>

	<!-- Charon Primary Stronghold 3 -->

	<StationType UNID="&stCharonPrimaryStronghold3;"
			name=				"Charon Pirates stronghold"
			sovereign=			"&svPirates;"
			abandonedScreen=	"&dsRPGAbandonedStation;"
			dockingPorts=		"8"

			multiHull=			"true"
			armorID=			"&itHeavyReactiveArmor;"
			hitPoints=			"200"
			regen=				"5"
			fireRateAdj=		"40"
			explosionType=		"&vtKineticExplosion3;"
			ejectaType=			"&vtWreckEjecta;"

			alertWhenDestroyed=	"30"

			attributes=			"charonPirates, enemy, human, majorStation, pirates, populated, primaryStronghold, uncharted"
			>

		<Image			imageID="&rsStations2;" imageX="0" imageY="768" imageWidth="180" imageHeight="180"/>

		<Devices>
			<Device deviceID="&itTurbolaserCannon;"	omnidirectional="true" posAngle="45"  posRadius="60"/>
			<Device deviceID="&itTurbolaserCannon;"	omnidirectional="true" posAngle="215" posRadius="60"/>
		</Devices>

		<Ships>
			<!-- Docked -->

			<Table>
				<Ship chance="10"	count="2d3"	class="&scViking;"		orders="guard"/>
				<Group chance="30">
					<Ship			count="1d6"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1d2"	class="&scCorsair-II;"	orders="guard"/>
				</Group>
				<Group chance="20">
					<Ship			count="1d4"	class="&scViking;"		orders="guard"/>
					<Ship			count="1"	class="&scCorsair-II;"	orders="guard"/>
				</Group>
				<Group chance="15">
					<Ship			count="1d2"	class="&scViking;"		orders="guard"/>
					<Ship			count="1"	class="&scDrake;"		orders="guard"/>
				</Group>
				<Group chance="15">
					<Ship			count="1d6"	class="&scCorsair;"		orders="guard"/>
					<Ship			count="1"	class="&scDrake;"		orders="guard"/>
				</Group>
				<Ship chance="10"	count="1d4"	class="&scCorsair-II;"	orders="guard"/>
			</Table>

			<!-- Patrol -->

			<Table>
				<Group chance="75">
					<Ship			count="1d6" class="&scViking;"		orders="patrol" patrolDist="15"/>
					<Ship			count="1d2" class="&scCorsair-II;"	orders="patrol" patrolDist="15"/>
				</Group>
				<Ship chance="25"	count="1"	class="&scCharonFrigateRaider;" eventHandler="&evCharonRaiderBehavior;"/>
			</Table>
		</Ships>

		<Reinforcements minShips="6">
			<Table>
				<Ship chance="35"	count="1d6"	class="&scCorsair;"		orders="guard"/>
				<Ship chance="35"	count="1d3"	class="&scViking;"		orders="guard"/>
				<Ship chance="20"	count="1d2"	class="&scCorsair-II;"	orders="guard"/>
				<Ship chance="10"	count="1"	class="&scDrake;"		orders="guard"/>
			</Table>
		</Reinforcements>

		<Items value="standard">
			<Item	count="2d8"	item="&itKM100Missile;" />
			<Lookup				table="&trStdLevelTreasure;"/>
		</Items>

		<DockingPorts>
			<Port x="51"	y="80" />
			<Port x="91"	y="42" />
			<Port x="101"	y="-54" />
			<Port x="61"	y="-90" />
			<Port x="-61"	y="-90" />
			<Port x="-101"	y="-54" />
			<Port x="-91"	y="42" />
			<Port x="-51"	y="80" />
		</DockingPorts>

	</StationType>

<!-- SHIP CLASSES -->

	<!-- Level 1: Corsair-class Gunship -->

	<ShipClass UNID="&scCorsair;"
			manufacturer=		"Neptune's Forge"
			class=				"Corsair"
			type=				"gunship"
			defaultSovereign=	"&svPirates;"

			size=				"26"
			mass=				"25"
			cargoSpace=			"5"
			thrustRatio=		"10"
			maxSpeed=			"25"

			attributes=			"charonPirates,genericClass"
			>

		<Armor>
			<ArmorSection start="270" span="180" armorID="&itUltraLightTitaniumCasing;"/>
			<ArmorSection start="90"  span="180" armorID="&itUltraLightTitaniumCasing;"/>
		</Armor>

		<Devices>
			<Device deviceID="&itLaserCannon;"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"9.0"
			rotationAccel=		"2.0"
			/>

		<Image imageID="&rsCorsairHD;" imageWidth="52" imageHeight="52" rotationCount="120" rotationColumns="12" viewportRatio="0.00375" rotationOffset="-10" />
		<HeroImage imageID="&rsCorsairHero;" imageWidth="320" imageHeight="320"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="144"	posRadius="10"	posZ="0"	rotation="180"/>
			<Effect type="thrustMain"		posAngle="-144"	posRadius="10"	posZ="0"	rotation="180"/>
		</Effects>
		
		<AISettings
			fireRateAdj=		"40"
			fireRangeAdj=		"30"
			fireAccuracy=		"75"
			perception=			"4"
			/>

	</ShipClass>

	<!-- Level 3: Corsair II-class Gunship -->

	<ShipClass UNID="&scCorsair-II;"
			manufacturer=		"Neptune's Forge"
			class=				"Corsair II"
			type=				"gunship"
			defaultSovereign=	"&svPirates;"
			level=				"3"

			attributes=			"charonPirates, genericClass, marauders"
			   
			size=				"26"
			mass=				"25"
			thrustRatio=		"10"
			maxSpeed=			"25"
			cargoSpace=			"5"
			>

		<!-- Configuration -->
		
		<Armor
			armorID=			"&itUltraLightTitaniumArmor;"
			count=				"2"
			/>
		
		<Devices>
			<Device deviceID="&itDualLaserCannon;"/>
			<Device deviceID="&itNAMIMissileLauncher;">
				<Items>
					<Item count="2d6" item="&itKM100Missile;"/>
				</Items>
			</Device>
			<Device deviceID="&itAClassDefenseScreen;"/>
		</Devices>

		<Maneuver
			maxRotationRate=	"9.0"
			rotationAccel=		"2.0"
			/>

		<Items>
			<Item count="1d6" item="&itHeliumAssembly;"/>
		</Items>

		<!-- Image and Effects -->
		
		<Image imageID="&rsCorsairHD;" imageWidth="52" imageHeight="52" rotationCount="120" rotationColumns="12" viewportRatio="0.00375" rotationOffset="-10" />
		<HeroImage imageID="&rsCorsairHero;" imageWidth="320" imageHeight="320"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="144"	posRadius="10"	posZ="0"	rotation="180"/>
			<Effect type="thrustMain"		posAngle="-144"	posRadius="10"	posZ="0"	rotation="180"/>
		</Effects>
		
		<!-- AI and Behavior -->

		<AISettings
			fireRateAdj=		"30"
			fireRangeAdj=		"50"
			fireAccuracy=		"80"
			ignoreShieldsDown=	"true"

			perception=			"4"
			/>

	</ShipClass>

	<!-- Level 3: Drake-class Missileship -->

	<ShipClass UNID="&scDrake;"
			manufacturer=		"Neptune's Forge"
			class=				"Drake"
			type=				"missileship"
			defaultSovereign=	"&svPirates;"

			level=				"3"
			attributes=			"capitalShip, charonPirates, genericClass, marauders"
			inherit=			"&baHumanTechShip;"
			>

		<!-- Hull -->

		<Hull
			size=				"66"
			mass=				"3200"
			cargoSpace=			"500"

			maxReactorPower=	"10000"
			maxCargoSpace=		"500"
			maxDevices=			"10"
			/>

		<Drive
			maxSpeed=			"12"
			thrust=				"6000"
			powerUse=			"500"
			/>

		<Maneuver
			maxRotationRate=	"4"
			rotationAccel=		"0.5"
			/>

		<DeviceSlots>
			<DeviceSlot id="omni1"		criteria="w"	posAngle="0"    posRadius="20"   posZ="10"	omnidirectional="true"/>
			<DeviceSlot id="port1"		criteria="w"	posAngle="58"   posRadius="34"   posZ="0"	fireAngle="80"	fireArc="160"	secondaryWeapon="true"/>
			<DeviceSlot id="starboard1" criteria="w"	posAngle="-58"  posRadius="34"   posZ="0"	fireAngle="-80"	fireArc="160"	secondaryWeapon="true"/>
		</DeviceSlots>

		<Interior>
			<Compartment name="interior"
					hitPoints=	"50"
					/>
			
			<Compartment name="main drive"
					type=		"mainDrive"
					hitPoints=	"30"

					posX=		"-34"
					posY=		"0"
					sizeX=		"28"
					sizeY=		"28"
					/>
		</Interior>

		<Wreck
			explosionType=		"&vtKineticExplosion3;"
			/>

		<!-- Configuration -->
		
		<Armor
			armorID=			"&itAdvancedReactiveArmor;"
			count=				"8"
			/>
		
		<Devices>
			<Device slotID="omni1"		deviceID="&itNAMIMissileLauncher;">
				<Items>
					<Table>
						<Item chance="85" count="10d20" item="&itKM100Missile;"/>
						<Item chance="15" count="10d20" item="&itFragmentationMissile;"/>
					</Table>
				</Items>
			</Device>
			<Device slotID="port1"		deviceID="&itLaserCannon;"/>
			<Device slotID="starboard1"	deviceID="&itLaserCannon;"/>
		</Devices>

		<Items>
			<Item count="1d6" item="&itHeliumAssembly;"/>
		</Items>

		<!-- Image and Effects -->

		<Image imageID="&rsDrakeHD;" imageWidth="96" imageHeight="96" rotationCount="120" rotationColumns="12" viewportRatio="0.009375"/>
		<HeroImage imageID="&rsDrakeHero;" imageWidth="320" imageHeight="320"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="171"	posRadius="42"	posZ="6"	rotation="180"	effect="&efMainThrusterLarge;"/>
			<Effect type="thrustMain"		posAngle="-171"	posRadius="42"	posZ="6"	rotation="180"	effect="&efMainThrusterLarge;"/>
		</Effects>
		
		<!-- AI and Behavior -->

		<AISettings
			aggressor=			"true"
			combatStyle=		"standOff"
			fireRateAdj=		"50"
			fireAccuracy=		"90"

			perception=			"4"
			/>

	</ShipClass>

	<!-- Level 2: Viking-class Gunship -->

	<ShipClass UNID="&scViking;"
			manufacturer=		"Neptune's Forge"
			class=				"Viking"
			type=				"gunship"
			defaultSovereign=	"&svPirates;"

			level=				"2"
			attributes=			"charonPirates, genericClass"
			inherit=			"&baHumanTechShip;"
			>

		<!-- Hull -->

		<Hull
			size=				"36"
			mass=				"150"
			cargoSpace=			"50"

			maxReactorPower=	"10000"
			maxCargoSpace=		"200"
			maxDevices=			"8"
			maxWeapons=			"2"

			maxArmor=			"superHeavy"
			stdArmor=			"medium"
			/>

		<Drive
			maxSpeed=			"20"
			thrust=				"600"
			/>

		<Maneuver
			maxRotationRate=	"7.0"
			rotationAccel=		"1.0"
			/>

		<!-- Configuration -->

		<Armor
			armorID=			"&itReactiveArmor;"
			count=				"2"
			/>

		<Devices>
			<Device deviceID="&itTurbolaserCannon;"/>
		</Devices>

		<Items>
			<Item count="2d6" item="&itHelium3FuelRod;"/>
		</Items>

		<!-- Image and Effects -->

		<Image imageID="&rsVikingHD;" imageWidth="68" imageHeight="68" rotationCount="120" rotationColumns="12" viewportRatio="0.005125"/>
		<HeroImage imageID="&rsVikingHero;" imageWidth="320" imageHeight="320"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="155"	posRadius="14"	posZ="0"	rotation="180"/>
			<Effect type="thrustMain"		posAngle="-155"	posRadius="14"	posZ="0"	rotation="180"/>
		</Effects>
		
		<!-- AI and Behavior -->

		<AISettings
			fireRateAdj=		"30"
			fireRangeAdj=		"50"
			fireAccuracy=		"85"
			perception=			"4"
			
			combatStyle=		"advanced"
			/>

	</ShipClass>

	<!-- Level 4: Viking II-class Gunship -->

	<ShipClass UNID="&scViking-II;"
			manufacturer=		"Neptune's Forge"
			class=				"Viking II"
			type=				"gunship"
			defaultSovereign=	"&svPirates;"

			attributes=			"charonPirates, genericClass, marauders"
			inherit=			"&baHumanTechShip;"
			>

		<!-- Hull -->

		<Hull
			size=				"36"
			mass=				"150"
			cargoSpace=			"50"

			maxReactorPower=	"10000"
			maxCargoSpace=		"200"
			maxDevices=			"8"
			maxWeapons=			"2"

			maxArmor=			"superHeavy"
			stdArmor=			"medium"
			/>

		<Drive
			maxSpeed=			"20"
			thrust=				"600"
			/>

		<Maneuver
			maxRotationRate=	"7.0"
			rotationAccel=		"1.0"
			/>

		<!-- Configuration -->

		<Armor
			armorID=			"&itHeavyReactiveArmor;"
			count=				"2"
			/>

		<Devices>
			<Device deviceID="&itDualTurbolaserCannon;"/>
			<Device deviceID="&itClass1Deflector;"/>
		</Devices>

		<Items>
			<Item count="1d6" item="&itHeliumAssembly;"/>
		</Items>

		<!-- Image and Effects -->
		
		<Image imageID="&rsVikingHD;" imageWidth="68" imageHeight="68" rotationCount="120" rotationColumns="12" viewportRatio="0.005125"/>
		<HeroImage imageID="&rsVikingHero;" imageWidth="320" imageHeight="320"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="155"	posRadius="14"	posZ="0"	rotation="180"/>
			<Effect type="thrustMain"		posAngle="-155"	posRadius="14"	posZ="0"	rotation="180"/>
		</Effects>
		
		<!-- AI and Behavior -->

		<AISettings
			fireRateAdj=		"30"
			fireRangeAdj=		"50"
			fireAccuracy=		"90"
			perception=			"4"
			
			combatStyle=		"advanced"
			/>

	</ShipClass>

	<!-- Level 4: Charon Frigate -->

	<ShipClass UNID="&scCharonFrigateStock;"
			manufacturer=		"Neptune's Forge"
			class=				"Charon frigate"
			type=				""
			defaultSovereign=	"&svPirates;"

			attributes=			"capitalShip, charonPirates, charonFrigate"
			inherit=			"&baHumanTechShip;"
			>

		<!-- Hull -->

		<Hull
			size=				"120"
			mass=				"7500"
			cargoSpace=			"1000"

			maxReactorPower=	"10000"
			maxCargoSpace=		"1000"
			maxDevices=			"12"
			/>

		<Drive
			maxSpeed=			"18"
			thrust=				"15000"
			powerUse=			"1000"
			/>

		<Maneuver
			maxRotationRate=	"4.0"
			rotationAccel=		"0.25"
			/>

		<DeviceSlots>
			<DeviceSlot id="omni1"		criteria="w"	posAngle="0"    posRadius="14"   posZ="20"	omnidirectional="true"/>
			<DeviceSlot id="port1"		criteria="w"	posAngle="40"   posRadius="35"   posZ="0"	fireAngle="80"	fireArc="170"	secondaryWeapon="true"/>
			<DeviceSlot id="port2"		criteria="w"	posAngle="114"  posRadius="26"   posZ="0"	fireAngle="90"	fireArc="170"	secondaryWeapon="true"/>
			<DeviceSlot id="starboard1"	criteria="w"	posAngle="-40"  posRadius="35"   posZ="0"	fireAngle="-80"	fireArc="170"	secondaryWeapon="true"/>
			<DeviceSlot id="starboard2"	criteria="w"	posAngle="-114" posRadius="26"   posZ="0"	fireAngle="-90"	fireArc="170"	secondaryWeapon="true"/>
		</DeviceSlots>

		<Interior>
			<Compartment name="interior"
					hitPoints=	"100"
					/>
			
			<Compartment name="main drive"
					type=		"mainDrive"
					hitPoints=	"50"

					posX=		"-52"
					posY=		"0"
					sizeX=		"26"
					sizeY=		"42"
					/>
		</Interior>

		<Wreck
			explosionType=		"&vtKineticExplosion4;"
			/>

		<!-- Configuration -->
		
		<Armor
			armorID=			"&itAdvancedReactiveArmor;"
			count=				"12"
			/>
		
		<Devices>
			<Device slotID="omni1"		deviceID="&itNAMIMissileLauncher;">
				<Items>
					<Table>
						<Item chance="85" count="10d20" item="&itKM500Missile;"/>
						<Item chance="15" count="15d20" item="&itFragmentationMissile;"/>
					</Table>
				</Items>
			</Device>
			<Device slotID="port1"		deviceID="&itTurbolaserCannon;"/>
			<Device slotID="port2"		deviceID="&itTurbolaserCannon;"/>
			<Device slotID="starboard1" deviceID="&itTurbolaserCannon;"/>
			<Device slotID="starboard2" deviceID="&itTurbolaserCannon;"/>
		</Devices>

		<Items>
			<Item count="2d6" item="&itHelium3FuelRod;"/>
		</Items>

		<!-- Image and Effects -->

		<Image imageID="&rsCharonFrigateHD;" imageWidth="140" imageHeight="140"	rotationCount="120" rotationColumns="12" viewportRatio="0.015625"/>

		<Effects>
			<Effect type="thrustMain"		posAngle="171"	posRadius="67"	posZ="0"	rotation="180"/>
			<Effect type="thrustMain"		posAngle="180"	posRadius="66"	posZ="0"	rotation="180"/>
			<Effect type="thrustMain"		posAngle="-171"	posRadius="67"	posZ="0"	rotation="180"/>
		</Effects>
		
		<!-- AI and Behavior -->

		<AISettings
			aggressor=			"true"
			fireRateAdj=		"50"
			fireAccuracy=		"90"
			perception=			"4"
			
			combatStyle=		"standOff"
			/>
	</ShipClass>

	<!-- Level 4: Charon Frigate

	GLOBAL DATA

	totalCreated:		Total number of frigates created

	totalDestroyed:		Total number of frigates destroyed by player

	-->

	<ShipClass UNID="&scCharonFrigateRaider;"
			manufacturer=		"Neptune's Forge"
			class=				"Charon frigate"
			type=				""
			defaultSovereign=	"&svPirates;"

			level=				"5"
			attributes=			"capitalShip, charonPirates, charonFrigate, genericClass"
			inherit=			"&scCharonFrigateStock;"

			achievement=		"humanSpace.charonFrigateKiller"
			>

		<Names definiteArticle="true">
			pirate ship Anemone; pirate ship Archelon; pirate ship Architeuthis;
			pirate ship Basilosaurus; pirate ship Charybdis; pirate ship Draug;
			pirate ship Grindylow; pirate ship Hippocampus; pirate ship Hydra;
			pirate ship J&#xf6;rmungandr; pirate ship Kraken; pirate ship Leviathan;
			pirate ship Moray Eel; pirate ship Morgawr; pirate ship Mosasaur;
			pirate ship Orca; pirate ship Pliosaur; pirate ship Proteus;
			pirate ship Rahab; pirate ship Rusalka; pirate ship Scylla;
			pirate ship Tiamat;	pirate ship Triton; pirate ship Undine;
			pirate ship Xuanlong;
		</Names>

		<!-- Configuration -->
		
		<Armor
			armorID=			"&itAdvancedReactiveArmor;"
			count=				"12"
			/>
		
		<Devices>
			<Device slotID="omni1"		deviceID="&itNAMIMissileLauncher;">
				<Items>
					<Table>
						<Item chance="85" count="10d20" item="&itKM500Missile;"/>
						<Item chance="15" count="15d20" item="&itFragmentationMissile;"/>
					</Table>
				</Items>
			</Device>
			<Device slotID="port1"		deviceID="&itTurbolaserCannon;" secondaryWeapon="true"/>
			<Device slotID="port2"		deviceID="&itTurbolaserCannon;" secondaryWeapon="true"/>
			<Device slotID="starboard1" deviceID="&itTurbolaserCannon;" secondaryWeapon="true"/>
			<Device slotID="starboard2" deviceID="&itTurbolaserCannon;" secondaryWeapon="true"/>
		</Devices>

		<Items>
			<Item count="2d6" item="&itHeliumAssembly;"/>
		</Items>

		<!-- AI and Behavior -->

		<Events>
			<OnCreate>
				;	Increment count of frigates created
				;	TODO - change to property
				
				(typIncData &scCharonFrigateRaider; 'totalCreated)
			</OnCreate>

			<OnDestroy>
				;	Keep track of how many frigates the player has destroyed
				
				(if (and gPlayerShip (eq aOrderGiver gPlayerShip))
					(block (totalDestroyed)
						(setq totalDestroyed (typIncData &scCharonFrigateRaider; 'totalDestroyed))

						; Tell Korolov that player has destroyed a frigate
						(korFrigateDestroyed)

						; If the player has destroyed 4 frigates, then we unleash the Kronosaurus
						; (if we haven't already--Korolov sends out Kronosaurus after 3 frigates)
						(if (eq totalDestroyed 4)
							(chrDeployKronosaurus)
							)
						)
					)
			</OnDestroy>
		</Events>
	</ShipClass>

<!-- ITEM TYPES -->

	<!-- Charon Pirate Map ROM -->

	<ItemType UNID="&itCharonPirateMapROM;"
			name=				"Charon base map ROM"
			level=				"3"
			value=				"100"
			mass=				"1"
			frequency=			"veryrare"
			unknownType=		"&itUnknownROM;, &itUnknownROMB;, &itUnknownROMC;"
			attributes=			"consumable, info, systemMap"

			description=		"This program contains the location of all Charon pirate bases in the system."
			>

		<Image imageID="&rsItems1;" imageX="192" imageY="96" imageWidth="96" imageHeight="96"/>

		<Invoke>
			(block (found)
				; We map all Charon stations
				(enum (sysFindObject gSource "AT:charonPirates;") obj
					(block Nil
						(objSetKnown obj)
						(setq found True)
						)
					)

				(if found
					(objSendMessage gSource Nil "Mapped all Charon pirate stations in system")
					(objSendMessage gSource Nil "No Charon pirate stations in system")
					)

				; Remove ROM
				(objRemoveItem gSource gItem 1)

				; Identify the item
				(itmSetKnown gItem)
				)
		</Invoke>
	</ItemType>

<!-- SHIP ENCOUNTER TABLES ================================================ -->

	<ShipTable unid="&etPirateAmbush;">
		<LevelTable>

			<!-- Level 1 -->

			<Ship	levelFrequency="crv-- -----"	class="&scCorsair;"		count="1d4+1"	orders="attack"	sovereign="&svPirates;"/>
			<Ship	levelFrequency="crv-- -----"	class="&scViking;"		count="1"		orders="attack"	sovereign="&svPirates;"/>

			<!-- Level 2 -->

			<Ship	levelFrequency="-crv- -----"	class="&scCorsair;"		count="2d3"		orders="attack"	sovereign="&svPirates;"/>
			<Group	levelFrequency="-crv- -----">
				<Ship								class="&scViking;"		count="1"		orders="attack"	sovereign="&svPirates;"/>
				<Ship								class="&scCorsair;"		count="1d4"		orders="attack"	sovereign="&svPirates;"/>
			</Group>

			<!-- Level 3 -->

			<Ship	levelFrequency="--crv -----"	class="&scCorsair;"		count="2d6+1"	orders="attack"	sovereign="&svPirates;"/>
			<Group	levelFrequency="--crv -----">
				<Ship								class="&scViking;"		count="1d4"		orders="attack"	sovereign="&svPirates;"/>
				<Ship								class="&scCorsair;"		count="1d6"		orders="attack"	sovereign="&svPirates;"/>
			</Group>
			<Group	levelFrequency="--crv -----">
				<Ship								class="&scCorsair-II;"	count="1d2"		orders="attack"	sovereign="&svPirates;"/>
				<Ship								class="&scCorsair;"		count="1d6"		orders="attack"	sovereign="&svPirates;"/>
			</Group>
			<Group	levelFrequency="--crv -----">
				<Ship								class="&scCorsair-II;"	count="1"		orders="attack"	sovereign="&svPirates;"/>
				<Ship								class="&scViking;"		count="1d4"		orders="attack"	sovereign="&svPirates;"/>
			</Group>

			<!-- Level 4 -->

			<Ship	levelFrequency="---cr v----"	class="&scViking;"		count="2d6+1"	orders="attack"	sovereign="&svPirates;"/>
			<Ship	levelFrequency="---cr v----"	class="&scCorsair-II;"	count="2d3"		orders="attack"	sovereign="&svPirates;"/>
			<Group	levelFrequency="---cr v----">
				<Ship								class="&scCorsair-II;"	count="1d6"		orders="attack"	sovereign="&svPirates;"/>
				<Ship								class="&scViking;"		count="1d6"		orders="attack"	sovereign="&svPirates;"/>
			</Group>

			<!-- Level 5+ -->

			<Group	levelFrequency="----c rvvvv">
				<Ship								class="&scDrake;"		count="1"		orders="attack"	sovereign="&svPirates;"/>
				<Ship								class="&scViking;"		count="2d6"		orders="attack"	sovereign="&svPirates;"/>
			</Group>
		</LevelTable>
	</ShipTable>

	<EncounterTable UNID="&etPirateAmbush1;">
		<Table>
			<Ship	chance="60"		count="3-5"		class="&scCorsair;"		orders="attack"	sovereign="&svPirates;"/>
			<Group	chance="40">
				<Ship				count="1-2"		class="&scCorsair;"		orders="attack"	sovereign="&svPirates;"/>
				<Ship				count="1"		class="&scViking;"		orders="attack"	sovereign="&svPirates;"/>
			</Group>
		</Table>
	</EncounterTable>

	<EncounterTable UNID="&etPirateAmbush2;">
		<Table>
			<Ship	chance="40"		count="5-7"		class="&scCorsair;"		orders="attack"	sovereign="&svPirates;"/>
			<Group	chance="30">
				<Ship		        count="3-5"		class="&scCorsair;"		orders="attack"	sovereign="&svPirates;"/>
				<Ship				count="1"		class="&scViking;"		orders="attack"	sovereign="&svPirates;"/>
			</Group>
			<Ship	chance="30"		count="2"		class="&scViking;"		orders="attack"	sovereign="&svPirates;"/>
		</Table>
	</EncounterTable>

	<EncounterTable UNID="&etPirateAmbush3;">
		<Table>
			<Ship	chance="10"		count="8-12"	class="&scCorsair;"		orders="attack"	sovereign="&svPirates;"/>
			<Group	chance="10">
				<Ship				count="3-5"		class="&scCorsair;"		orders="attack"	sovereign="&svPirates;"/>
				<Ship				count="2"		class="&scViking;"		orders="attack"	sovereign="&svPirates;"/>
			</Group>
			<Ship	chance="15"		count="3-4"		class="&scViking;"		orders="attack"	sovereign="&svPirates;"/>
			<Group	chance="25">
				<Ship				count="2-4"		class="&scCorsair;"		orders="attack"	sovereign="&svPirates;"/>
				<Ship				count="1"		class="&scCorsair-II;"	orders="attack"	sovereign="&svPirates;"/>
			</Group>
			<Group	chance="25">
				<Ship				count="2"		class="&scViking;"		orders="attack"	sovereign="&svPirates;"/>
				<Ship				count="1"		class="&scCorsair-II;"	orders="attack"	sovereign="&svPirates;"/>
			</Group>
			<Ship	chance="15"		count="2"		class="&scCorsair-II;"	orders="attack"	sovereign="&svPirates;"/>
		</Table>
	</EncounterTable>

	<EncounterTable UNID="&etPirateAmbush4;">
		<Table>
			<Ship	chance="15"		count="8-12"	class="&scViking;"		orders="attack"	sovereign="&svPirates;"/>
			<Group	chance="25">
				<Ship				count="3-5"		class="&scViking;"		orders="attack"	sovereign="&svPirates;"/>
				<Ship				count="2"		class="&scCorsair-II;"	orders="attack"	sovereign="&svPirates;"/>
			</Group>
			<Ship	chance="30"		count="3-4"		class="&scCorsair-II;"	orders="attack"	sovereign="&svPirates;"/>
			<Group	chance="30">
				<Ship				count="2"		class="&scCorsair-II;"	orders="attack"	sovereign="&svPirates;"/>
				<Ship				count="1"		class="&scDrake;"		orders="attack"	sovereign="&svPirates;"/>
			</Group>
		</Table>
	</EncounterTable>

	<EncounterTable UNID="&etMarauderAmbush1;">
		<Table>
			<Ship chance="60" count="1d3+1"	class="&scViking-II;"	orders="attack"	sovereign="&svMarauders;"/>
			<Group chance="40">
				<Ship         count="1d3"	class="&scViking-II;"	orders="attack"	sovereign="&svMarauders;"/>
				<Ship         count="1"		class="&scCorsair-II;"	orders="attack"	sovereign="&svMarauders;"/>
			</Group>
		</Table>
	</EncounterTable>

	<EncounterTable UNID="&etMarauderAmbush2;">
		<Table>
			<Ship chance="40" count="2d3"	class="&scViking-II;"	orders="attack"	sovereign="&svMarauders;"/>
			<Group chance="30">
				<Ship         count="1d4+1"	class="&scViking-II;"	orders="attack"	sovereign="&svMarauders;"/>
				<Ship         count="1"		class="&scCorsair-II;"	orders="attack"	sovereign="&svMarauders;"/>
			</Group>
			<Ship chance="30" count="2"	class="&scCorsair-II;"	orders="attack"	sovereign="&svMarauders;"/>
		</Table>
	</EncounterTable>

<!-- BEHAVIORS -->
	
	<!-- Charon Raider Behavior
	
	EXTRA DATA

	ambushMarker:		Marker where we wait to ambush freighter

	cargoValue:			Value of cargo that we are going after

	end:				Transport path destination

	raiderCount:		Current number of raiders
	raiderMaxCount:		Max number of raiders
	raiderMinCount:		Summon more raiders when we fall below this count
	raiderClassTable:	Probability table for raider class

	start:				Transport path origin

	status:				Current ship status:
							Nil						= no mission yet
							'wander					= wander around
							'wander.attacking		= attacking a freighter
							'wander.travelling		= traveling to ambush position
							'wander.waiting			= waiting at ambush position
							'raid.travelling		= traveling to ambush marker
							'raid.waitForTransport	= waiting for transport to come in range
							'raid.waitForRaiders	= waiting for raiders to destroy transport
							'raid.attacking			= attacking transport directly
							'raid.defending			= defending against player attacks
							'dockWithWreck			= docking with transport
							'dockWithBase			= dock with pirate base and dump loot
							'leaveSystem			= leave the system
							'patrol					= patroling
							'ambush					= random encounter
							'attackingEnemy			= attacking enemy

	targetID:			Transport to ambush

	targetBase:			Base to dump loot at

	wreckID:			Transport wreck to loot


	SHIP DATA

	charonFrigate:		Raiders have this variable to point back to this frigate

	-->
	
	<Type UNID="&evCharonRaiderBehavior;">
		<StaticData>
			<raidersTableIndex>
				(	; chance	table				min		max
					(25			'raidersTable1		3		(random '(4 5 5 5 5 6 6 8)))
					(55			'raidersTable2		3		(random '(5 5 5 5 6 8)))
					(60			'raidersTable3		2		(random '(4 4 4 4 4 5 5 5 6)))
					(75			'raidersTable4		3		(random '(4 5 5 5 5)))
					(80			'raidersTable5		2		(random '(3 3 3 3 3 3 4 4)))
					(100		'raidersTable6		3		(random '(4 5 5 5 5 5 6 6)))
					)
			</raidersTableIndex>

			<raidersTable1>
				(	; chance	class
					(100		&scCorsair;)
					)
			</raidersTable1>

			<raidersTable2>
				(	; chance	class
					(80			&scCorsair;)
					(100		&scViking;)
					)
			</raidersTable2>

			<raidersTable3>
				(	; chance	class
					(50			&scCorsair;)
					(100		&scViking;)
					)
			</raidersTable3>

			<raidersTable4>
				(	; chance	class
					(80			&scCorsair;)
					(100		&scCorsair-II;)
					)
			</raidersTable4>

			<raidersTable5>
				(	; chance	class
					(100		&scViking;)
					)
			</raidersTable5>

			<raidersTable6>
				(	; chance	class
					(60			&scCorsair;)
					(90			&scViking;)
					(100		&scCorsair-II;)
					)
			</raidersTable6>
		</StaticData>
		
		<Properties>
			<Definition id="charon.raider">True</Definition>
			<Global id="rpg.debug">True</Global>

			<Data id="status"></Data>
			<Data id="baseID"></Data>
			<Data id="targetID"></Data>
			<Data id="cargoValue"></Data>
			<Data id="wreckID"></Data>

			<Data id="raiderIDs"></Data>
			<Data id="raiderMinCount"></Data>
			<Data id="raiderMaxCount"></Data>
			<DynamicData id="raiderCount">(count (obj@ gSource 'raiderIDs))</DynamicData>

			<Data id="wanderMaxDamage">50</Data>
			<Data id="raidMaxDamage">80</Data>
		</Properties>

		<Events>
			<OnEventHandlerInit>

				;	Called when the event handler is assigned to a space object.
				;	If we are assigned at object creation this will be before the OnCreate event is called.

				;	gType = type of space object
				;	gSource = space object

				(block (
					(tableIndex (typ@ &evCharonRaiderBehavior; 'raidersTableIndex))
					(roll (switch
						(= (sysGetLevel) 1)
							(random 1 70)
						(= (sysGetLevel) 2)
							(random 1 90)
						(random 1 100)
						))

					i
					)
					(if (obj@ gSource 'rpg.debug) (dbgOutput "OnEventHandlerInit " (objGetName gSource)))
					;	Choose a random raider table

					(setq i 0)
					(loop (gr roll (@ (@ tableIndex i) 0))
						(setq i (add i 1))
						)

					;	Store the raider table

					(setq tableEntry (@ tableIndex i))
					(objSetData gSource "raiderClassTable" (typ@ &evCharonRaiderBehavior; (@ tableEntry 1)))
					(objSet@ gSource 'raiderMinCount (eval (@ tableEntry 2)))
					(objSet@ gSource 'raiderMaxCount (eval (@ tableEntry 3)))

					;	Register timer event to control behavior

					(sysAddObjRecurringTimerEvent 60 gSource "OnBehaviorControl")
					(objSet@ gSource 'status 'wander)
					)
			</OnEventHandlerInit>

			<OnCreate>

				;	Called in place of the space object OnCreate if we are assigned at object creation.
				;
				;	gType, gSource, aBaseObj, aOwnerObj, aTargetObj, aOrbit

				(block ()
					;	Call the base class so that it can create raiders or
					;	whatever.
					;
					;	NOTE: Obviously we have to use typFireObjEvent instead of
					;	objFireEvent because the latter will call us right back
					;	here and infinitely recurse.
					(if (obj@ gSource 'rpg.debug) (dbgOutput "OnCreate(event) " (objGetName gSource)))

					(typFireObjEvent (objGetType gSource) gSource 'OnCreate)

					;	Create some raiders to accompany us

					(for i 1 (obj@ gSource 'raiderMaxCount)
						(chrCreateRaider gSource gSource)
						)
					)
			</OnCreate>

			<OnCreateOrders>
				;	Called if the spaceobject was created by a Ship or Encounter table. Will be called after OnCreate
				;
				;	gType, gSource, aBaseObj, aTargetObj

				(block Nil
					(if (obj@ gSource 'rpg.debug) (dbgOutput "OnCreateOrders " (objGetName gSource)))
					(objSet@ gSource 'baseID (objGetID aBaseObj))
					(objSet@ gSource 'targetID (objGetID aTargetObj))
					(objAddSubordinate aBaseObj gSource)

					;	If we have a target then we were created as an encounter, otherwise
					;	we were created as a station guard

					(if aTargetObj
						(objFireEvent gSource 'OrderAmbush)
						(objFireEvent gSource 'OrderPatrol)
						)
					)
			</OnCreateOrders>


			<OrderAmbush>
				;	This was probably never working as intended.
				;	The initial event orders the frigate to move towards into the players current path
				;	However, as soon as we detect any enemy, we change state to 'attackingEnemy and add orders:
				;		* 'attack theEnemy
				;		* 'attackNearestEnemy

				; aBaseObj = base
				
				(block (
					(theEncounter (intComputeRandomEncounterPosEx))
					(thePos (@ theEncounter 0))
					)
					(if (obj@ gSource 'rpg.debug) (dbgOutput "OrderAmbush " (objGetName gSource)))

					; First we position ourselves in the path of the player
					(objMoveTo gSource thePos)

					; Move towards the player's path
					(setq theCourse (@ theEncounter 1))
					(shpCancelOrders gSource)
					(shpOrder gSource 'holdCourse theCourse 300)
					
					(objSet@ gSource 'status 'ambush)
					)
			</OrderAmbush>
			
			<OrderPatrol>
				(block (
					(baseObj (or
						(@ gData 'aBaseObj))
						(objGetObjByID (obj@ gSource 'baseID))
						aBaseObj		;	Backward compatibility
						)
					(dist (or (@ gData 'distance)) 20)
					)
					(if (obj@ gSource 'rpg.debug) (dbgOutput "OrderPatrol " (objGetName gSource)))

					(shpCancelOrders gSource)
					(shpOrder gSource 'patrol baseObj dist)
					(objSet@ gSource 'status 'patrol)
					)
			</OrderPatrol>
			
			<OrderWander>
				(block Nil
					(if (obj@ gSource 'rpg.debug) (dbgOutput "OrderWander " (objGetName gSource)))

					(objSet@ gSource 'status 'wander)
					(shpCancelOrders gSource)
					(shpOrder gSource 'wander)

					; Order the raiders to return
					(chrCancelRaiderOrders gSource)
					(chrOrderRaiders gSource 'escort gSource)
					)
			</OrderWander>

			<OrderLootWreck>
				;	gData = wreck to loot
				(block Nil
					(if (obj@ gSource 'rpg.debug) (dbgOutput "OrderLootWreck " (objGetName gSource)))

					(objSet@ gSource 'status 'dockWithWreck)
					(objSet@ gSource 'wreckID (objGetID gData))

					(shpCancelOrders gSource)
					(shpOrder gSource 'dock gData)
					(shpOrder gSource 'wait (random 5 10))

					; Order the raiders to attack the nearest enemy
					(chrCancelRaiderOrders gSource)
					(chrOrderRaiders gSource "attackNearestEnemy")
					(chrOrderRaiders gSource "escort" gSource)
					)
			</OrderLootWreck>

			<OrderRaidTransport>
				(block (
					(aTargetObj (@ gData 'aTargetObj))		; transport to raid
					(aOriginObj (@ gData 'aOriginObj))		; transport origin
					(aDestObj (@ gData 'aDestObj))			; transport destination
					(aCargoValue (@ gData 'aCargoValue))	; value of cargo

					(inPath (and (leq (random 1 100) 30) (geq aCargoValue 100000)))
					ambushPos
					)
					(if (obj@ gSource 'rpg.debug) (dbgOutput "OrderRaidTransport " (objGetName gSource) (if inPath " (on path)" "")))

					; 30% of the time we pick a spot on the transports's path
					; the rest of the time we pick a random spot near (but not on)
					; the transport's path
					(if inPath
						(setq ambushPos (sysGetNavPathPoint &svCorporate; aOriginObj aDestObj (random 40 50)))
						(setq ambushPos (chrComputeAmbushPos aOriginObj aDestObj))
						)

					; Go to the ambush position
					(shpCancelOrders gSource)
					(shpOrder gSource 'gotoPos ambushPos)

					; Clear any previous target
					(objFireEvent gSource 'ClearTarget)

					; Set our state and remember the target
					(objSet@ gSource 'targetID (objGetID aTargetObj))
					(objRegisterForEvents gSource aTargetObj)

					(objSetObjRefData gSource "start" aOriginObj)
					(objSetObjRefData gSource "end" aDestObj)

					(objSet@ gSource 'cargoValue aCargoValue)

					(objSet@ gSource 'status 'raid.traveling)
					)
			</OrderRaidTransport>

			<OrderFlee>
				(block (
					(debug (obj@ gSource 'rpg.debug))
					(pirateBase (sysFindObject gSource "ANTJ +majorStation;"))
					(nearestEnemy (sysFindObject gSource "ANEX"))
					)
					(if debug (dbgOutput "OrderFlee " (objGetName gSource)))
					; If there is a Charon stronghold in system, dock with it. Otherwise, we gate out
					(if pirateBase
						(block Nil
							(objSet@ gSource 'status 'dockWithBase)
							(shpCancelOrders gSource)
							(shpOrder gSource 'dock pirateBase)
							(shpOrder gSource 'wait (random 3 7))
							)
						(block Nil
							(objSet@ gSource 'status 'leaveSystem)
							(shpCancelOrders gSource)
							(shpOrder gSource 'gate)
							)
						)

					; Clear any previous target
					(objFireEvent gSource 'ClearTarget)

					; Order the raiders to attack the nearest enemy
					(chrCancelRaiderOrders gSource)
					(if nearestEnemy (chrOrderRaiders gSource 'attack nearestEnemy))
					(chrOrderRaiders gSource 'escort gSource)
					)
			</OrderFlee>

			<ClearTarget>
				(block (
					(targetObj (objGetObjByID (obj@ gSource 'targetID)))
					)
					(if targetObj
						(objUnregisterForEvents gSource targetObj)
						)
					(objSet@ gSource 'targetID Nil)
					)
			</ClearTarget>

			<OnBehaviorControl>
				(block (
					(debug (obj@ gSource 'rpg.debug))
					(status (obj@ gSource 'status))
					(targetObj (objGetObjByID (obj@ gSource 'targetID)))
					)

					(switch
						; If we're close enough to the transport and we've got enough
						; raiders, then send them out
						(and (= status 'raid.waitForTransport)
								(ls (objGetDistance gSource targetObj) 180)
								(geq (obj@ gSource "raiderCount") 4)
								)
							(block Nil
								(if debug (dbgOutput "Charon raider launching raiders"))
								(chrCancelRaiderOrders gSource)
								(chrOrderRaiders gSource "attack" targetObj 0)
								(objSet@ gSource 'status 'raid.waitForRaiders)
								)
								
						(eq status 'ambush)
							(block (theEnemy)
								(if (setq theEnemy (sysFindObject gSource "sEPAN"))
									(block Nil
										(shpCancelOrders gSource)
										(shpOrder gSource 'attack theEnemy)
										(shpOrder gSource 'attackNearestEnemy)
										(objSet@ gSource 'status 'attackingEnemy)
										)
									)
								)
						; Wander behavior and substates
						(strBeginsWith status 'wander)
							(switch
								; If we're damaged then retreat
								(gr (obj@ gSource 'visibleDamage) (obj@ gSource 'wanderMaxDamage))
									(objFireEvent gSource 'OrderFlee)

								; If we're busy then continue
								(= status 'wander.attacking)
									Nil

								; If there's a freighter in the area, then attack it.
								(and (setq targetObj (sysFindObject gSource "sAEPN +freighter;"))
									(gr (shpGetMaxSpeed gSource) (shpGetMaxSpeed targetObj))
									)
									(block Nil
										(if debug (dbgOutput "Charon raider: attacking " (objGetName targetObj)))
										(objSet@ gSource 'status 'wander.attacking)
										(objSet@ gSource 'targetID (objGetID targetObj))
										(objRegisterForEvents gSource targetObj)

										; Send raiders
										(chrCancelRaiderOrders gSource)
										(chrOrderRaiders gSource 'attack targetObj)

										; and attack directly
										(shpCancelOrders gSource)
										(shpOrder gSource 'attack targetObj)
										)

								; LATER - Check for wrecks to loot

								; If we're idle, then find a place to wait for prey
								(= status 'wander)
									(block ()
										(setq targetObj (or
											(sysFindObject gSource "TAEN +populated; R:150; -uncharted;")
											(sysFindObject gSource "GN")
											))
										(if debug (dbgOutput "Charon raider: approaching " (objGetName targetObj)))

										(shpCancelOrders gSource)
										(shpOrder gSource 'goToPos (sysVectorRandom targetObj 80 50))
										(objSet@ gSource 'status 'wander.traveling)
										)

								; If we're waiting for prey, we time out after a while
								(= status 'wander.waiting)
									(if (leq (random 1 100) 5)
										(objSet@ gSource 'status 'wander)
										)

								(if debug (dbgOutput "Charon raider status: " status))
								)

						; (dbgOutput "Charon raider status: " status)
						)

					; If we don't have enough raiders, create some new ones
					(if (ls (obj@ gSource 'raiderCount) (obj@ gSource 'raiderMinCount))
						(block Nil
							(for i (obj@ gSource 'raiderCount) (obj@ gSource 'raiderMaxCount)
								(chrCreateRaider gSource (sysFindObject gSource "GN -uncharted;"))
								)
								
							;	If we were previously waiting for raiders to destroy a freighter,
							;	then this means they got destroyed, so wait for the transport again
							;	in case it comes back this way
							
							(if (= (obj@ gSource 'status) 'raid.waitForRaiders)
								(objSet@ gSource 'status 'raid.waitForTransport)
								)
							)
						)
					)
			</OnBehaviorControl>

			<OnAttacked>
				(block (
					(debug (obj@ gSource 'rpg.debug))
					(status (obj@ gSource 'status))
					targetObj
					)
					(switch
						;	If no one is reponsible, then nothing to do

						(not (objCanAttack aOrderGiver))
							Nil

						;	If this is a friend, then ignore

						(= (objGetDisposition gSource aOrderGiver) 'friend)
							Nil

						;	If we're badly damaged then flee. There are different limits for wander and raid states.

						(and (strBeginsWith status 'wander)
								(gr (obj@ gSource 'visibleDamage) (obj@ gSource 'wanderMaxDamage)))
							(objFireEvent gSource 'OrderFlee)

						(and (strBeginsWith status 'raid)
								(gr (obj@ gSource 'visibleDamage) (obj@ gSource 'raidMaxDamage)))
							(objFireEvent gSource 'OrderFlee)

						;	If the player attacks during a raid and we're moderately damaged (between wanderMax and raidMax)
						;	then the player is a serious threat so we need to retaliate.

						(and (= aOrderGiver gPlayerShip)
								(strBeginsWith status 'raid)
								(!= status 'raid.defending)
								(gr (obj@ gSource 'visibleDamage) (obj@ gSource 'wanderMaxDamage))
								)
							(block Nil
								(if debug (dbgOutput "Charon raider: retaliating against player"))
								(objSet@ gSource 'status 'raid.defending)
								(shpCancelOrders gSource)
								(shpOrder gSource 'attack gPlayerShip)
								)


						;	If player attacks us while raiders are engaging, then engage directly.

						(and (= aOrderGiver gPlayerShip)
								(= status 'raid.waitForRaiders)
								(setq targetObj (objGetObjByID (obj@ gSource 'targetID)))
								(geq (obj@ gSource 'maxSpeed) (* (obj@ targetObj 'maxSpeed) 1.25 ))
								)
							(block Nil
								(if debug (dbgOutput "Charon raider: attacking transport"))
								(objSet@ gSource 'status 'raid.attacking)
								(shpCancelOrders gSource)
								(shpOrder gSource 'attack targetObj)
								)

						;	If we're waiting for a transport to show up and we get attacked, then
						;	attack back.

						(or (= status 'raid.waitForTransport) (= status 'raid.waitForRaiders))
							(if (!= (shpGetOrder gSource) 'attack)
								(shpOrderImmediate gSource 'attack aOrderGiver (random 10 30))
								)

						)
					)
			</OnAttacked>

			<OnObjDestroyed>
				(block (
					(debug (obj@ gSource 'rpg.debug))
					(status (obj@ gSource 'status))
					)
					(switch
						; If transport got destroyed, dock with its wreck
						(= (objGetID aObjDestroyed) (obj@ gSource 'targetID))
							(if aWreckObj
								; If we have a wreck, dock with it
								(objFireEvent gSource 'OrderLootWreck aWreckObj)

								; Otherwise, back to wandering
								(objFireEvent gSource 'OrderWander)
								)

						; If one of our raiders got destroyed, decrement our count
						(find (obj@ gSource 'raiderIDs) (objGetID aObjDestroyed))
							(block (
								(raiderIDs (obj@ gSource 'raiderIDs))
								(targetObj (objGetObjByID (obj@ gSource 'targetID)))
								)

								(objSet@ gSource 'raiderIDs (lnkRemove raiderIDs (find raiderIDs (objGetID aObjDestroyed))))

								; If we're attacking a freighter and our raiders have
								; been almost destroyed, there is a chance that we 
								; engage directly.

								(if (and (= status 'raid.waitForRaiders)
										(leq (obj@ gSource 'raiderCount) 1)
										(leq (obj@ gSource 'visibleDamage) (obj@ gSource 'wanderMaxDamage))
										(geq (obj@ gSource 'maxSpeed) (* (obj@ targetObj 'maxSpeed) 1.25 ))
										(geq (obj@ gSource 'cargoValue) 100000)
										(leq (random 1 100) (divide (obj@ gSource 'cargoValue) 20000))
										)
									(block Nil
										(if debug (dbgOutput "Charon frigate attacking transport"))
										(objSet@ gSource 'status 'raid.attacking)
										(shpCancelOrders gSource)
										(shpOrder gSource 'attack targetObj)
										)
									)
								)
						)
					)
			</OnObjDestroyed>

			<OnObjDocked>
				(block Nil
					;	If freighter returns to origin go back to wandering
					
					(if (and (eq (objGetID aObjDocked) (obj@ gSource 'targetID)) (eq aDockTarget (objGetObjRefData gSource "start")))
						(objFireEvent gSource 'OrderWander)
						)
					)
			</OnObjDocked>
			
			<OnOrdersCompleted>
				(block (
					(debug (obj@ gSource 'rpg.debug))
					(status (obj@ gSource 'status))
					)
					(switch
						; If we reached our ambush position, send out raiders
						(= status 'raid.traveling)
							(block Nil
								(if debug (dbgOutput "Charon raider at ambush position"))
								(shpOrder gSource "hold")
								(objSet@ gSource 'status 'raid.waitForTransport)
								)

						; If we finish defending, then the player is probably dead. Just go back to wandering
						(= status 'raid.defending)
							(objFireEvent gSource 'OrderWander)

						(= status 'wander.traveling)
							(block Nil
								(if debug (dbgOutput "Charon raider at ambush position"))
								(shpOrder gSource 'hold)
								(objSet@ gSource 'status 'wander.waiting)
								)

						; If we've docked with the transport, then loot the goods
						; and take them to a pirate base
						(= status 'dockWithWreck)
							(block (
								(wreck (objGetObjByID (obj@ gSource 'wreckID)))

								; If we are damaged dock at a major station, otherwise use nearest
								(pirateBase
									(if (gr (obj@ gSource 'visibleDamage) (obj@ gSource 'wanderMaxDamage))
										(sysFindObject gSource "ANTJ +majorStation;")
										(sysFindObject gSource "ANTJ")
										)
									)
								)
								(if debug (block Nil
									(dbgOutput "Charon raider looting " (objGetName wreck))
									(dbgOutput "Remaing cargo space " (/ (objGetCargoSpaceLeft gSource) 1000))
									(dbgOutput "damage: " (obj@ gSource 'visibleDamage gSource))
									))
								; Loot all items from the transport
								(if wreck
									(intLootAllItems wreck gSource "*U" True)
									(dbgOutput "Charon raider ERROR - no wreck")
									)
								(objSetData wreck 'charon.salvaged True)

								(switch
									; Low damage and over 100 tons cargo space left, continue wandering
									(and (leq (obj@ gSource 'visibleDamage) 20)
										(gr (objGetCargoSpaceLeft gSource) 100000)
										)
										(objFireEvent gSource 'OrderWander)

									; If we found a base, dock with it.
									pirateBase
										(block Nil
											(objSet@ gSource 'status 'dockWithBase)
											(objSetObjRefData gSource "targetBase" pirateBase)
											(shpOrder gSource 'dock pirateBase)
											(shpOrder gSource 'wait (random 3 7))
											(if debug (dbgOutput "Charon raider: return to base"))
											)

									; Otherwise, we gate out
									(block Nil
										(objSet@ gSource 'status 'leaveSystem)
										(shpOrder gSource 'gate)
										(if debug (dbgOutput "Charon raider: leave system"))
										)
									)
								)

						; If we're docked with the pirate base, then dump the loot and
						; go back to wandering
						(= status 'dockWithBase)
							(block (
								(dockTarget (shpGetDockObj gSource))
								(allItems (objGetItems gSource "*U~mf -ID;"))
								)
								(if debug (dbgOutput "(OnOrdersCompleted) Charon raider docked with: " (objGetName dockTarget)))

								; If base is populated then dump cargo
								(if (objMatches dockTarget Nil "AT +populated;")
									(enum allItems theItem
										(block Nil
											(objRemoveItem gSource theItem)
											(if (not (itmIsEqual theItem &itKorolovShippingContainer;))
												(objAddItem dockTarget theItem)
												)
											)
									))

								; Repair
								(if (objMatches dockTarget Nil "AT +populated; +majorStation;")
									(block Nil
										(intArmorRepairAll gSource)
										(objRemoveCondition gSource 'radioactive)
										(objRemoveCondition gSource 'fouled)
										(objSet@ gSource 'interiorHP (obj@ gSource 'maxInteriorHP))
										)
									)

								; Wander the system
								(objFireEvent gSource 'OrderWander)
								)
								
						; Back to patrol
						(eq status 'attackingEnemy)
							(block Nil
								(setq aBaseObj (objGetObjRefData gSource "targetBase"))
								(objFireEvent gSource "OrderPatrol")
								)

						; If we don't know what to do, just wait
						(block Nil
							(if debug (dbgOutput "Charon frigate doesn't have a mission"))
							(shpOrder gSource "hold")
							)
						)
					)
			</OnOrdersCompleted>
		</Events>
	</Type>
	
<!-- GLOBALS -->

	<Globals>
		(block Nil
			(setq chrCancelRaiderOrders (lambda (frigateObj)
				"Call shpCancelOrders for all raiders following this leader"
				(enum (obj@ frigateObj 'raiderIDs) raiderID
					(shpCancelOrders (objGetObjByID raiderID))
					)
				))

			(setq chrComputeAmbushPos (lambda (fromObj toObj)
				(block (pathPercent pathVector p0 p1 p2)
					; Pick a random position along the path
					(setq pathPercent (random 40 60))
					(setq p0 (sysGetNavPathPoint
						&svCorporate;
						fromObj
						toObj
						pathPercent
						))

					; Get two other points along the path to form a vector parallel to
					; the path
					(setq p1 (sysGetNavPathPoint
						&svCorporate;
						fromObj
						toObj
						(subtract pathPercent 10)
						))
					(setq p2 (sysGetNavPathPoint
						&svCorporate;
						fromObj
						toObj
						(add pathPercent 10)
						))
					(setq pathVector (sysVectorSubtract p2 p1))

					; Compute a point a random distance from the path
					(sysVectorPolarOffset
						p0
						(add (sysVectorAngle pathVector) (random '(90 270)))
						(random 60 100)
						)
					)
				))

			(setq chrCreateRaider (lambda (frigateObj pos)
				(block (raider found i classTable class roll)
					; Get the probability table from the frigate
					(setq classTable (objGetData frigateObj "raiderClassTable"))

					; Pick a random class for the raider
					(setq roll (random 1 100))
					(setq i 0)
					(loop (gr roll (item (item classTable i) 0))
						(setq i (add i 1))
						)
					(setq class (item (item classTable i) 1))

					; Create the raider
					(setq raider (sysCreateShip class pos (objGetSovereign frigateObj)))
					;(dbgOutput "Created " (objGetName raider))

					; Order the raider to escort the frigate and remember a
					; pointer to the frigate
					(shpOrder raider "escort" frigateObj)
					(objSetObjRefData raider "charonFrigate" frigateObj)

					; Remember a pointer to the raider
					(objRegisterForEvents frigateObj raider)

					; Add the raider to a list
					(objSet@ frigateObj 'raiderIDs (lnkAppend (obj@ frigateObj 'raiderIDs) (objGetID raider)))
					)
				))

			(setq chrDeployFrigateRaid (lambda (transportObj homeBaseObj travelObj cargoValue raiderType)
				(block (
					(debug (typ@ &evCharonRaiderBehavior; 'rpg.debug))

					;	Compute the half-way point of the transport route
					(raidPos (sysGetNavPathPoint &svCorporate; homeBaseObj travelObj 50))

					;	Time for freighter to reach the ambush position
					(travelTime (sysCalcTravelTime (sysVectorDistanceExact homeBaseObj raidPos) (obj@ transportObj 'maxSpeed)))

					;	Look for any free raiders that can reach the raid position in time
					(frigateList (filter (sysFindObject Nil "s +property:charon.raider;") raider
						(and
							(strBeginsWith (obj@ raider 'status) 'wander)
							(ls (sysCalcTravelTime (sysVectorDistanceExact raider raidPos) (obj@ raider 'maxSpeed)) travelTime)
							)
						))

					frigate
					)

					;	Default to Charon frigate

					(if (not raiderType) (setq raiderType &scCharonFrigateRaider;))

					;	Choose an existing raider or create a new one
					;	Currently allow all existing raider types when reusing
					
					(if frigateList
						(block Nil
							(setq frigate (random frigateList))
							(if debug (dbgOutput "Found frigate: " (objGetID frigate)))
							)
						(block Nil
							(setq frigate (sysCreateShip raiderType raidPos &svPirates; &evCharonRaiderBehavior;))
							(if debug (dbgOutput "Created " (objGetName frigate 0x00) ": " (objGetID frigate)))
							)
						)

					;	Order raid
					
					(objFireEvent frigate 'OrderRaidTransport {
						aTargetObj: transportObj
						aOriginObj: homeBaseObj
						aDestObj: travelObj
						aCargoValue: cargoValue
						})
					)
				))

			(setq chrDeployKronosaurus (lambda ()
				(block (
					(theStation (sysFindObject Nil "ATN +korolovShipping;"))
					(theMission (msnCreate &msKronosaurus; theStation))
					)
					(if theMission (msnAccept theMission))
					)
				))

			(setq chrGetPrimaryStronghold (lambda (sourceObj)
				(block (strongholdObj)
					; See if the stronghold exists already
					(setq strongholdObj (sysFindObject sourceObj "TN +charonPirates; +primaryStronghold;"))

					; If it does not exist, create one
					(if (not strongholdObj)
						(block (
							;	Find the closest star

							(stars (sysFindObject sourceObj "t +star; S:d;"))
							(firstStar (@ stars 0))
							(planets (sysFindObject firstStar "t +isPlanet:true; S:D;"))

							;	Find the farthest planet

							(farthestPlanetDist
								(map planets '(reduceMax excludeNil) thePlanet
									(if (= firstStar (sysFindObject thePlanet "tN +star;"))
										(sysVectorDistance thePlanet firstStar)
										)
									)
								)

							;	Compute best distance

							(bestDist
								(if (ls farthestPlanetDist 360)
									(random 480 600)
									(+ farthestPlanetDist (random 120 240))
									)
								)

							strongholdPos strongholdType badAngles triesLeft
							)
							
							; Compute the position of the primary stronghold. It must be
							; in the outer system far from anything else.
							; Also try to avoid being too close to the path to another star.
							
							(setq badAngles (map (subset stars 1) otherStar (sysVectorAngle otherStar firstStar)))
							(setq triesLeft 10)
							(loop (gr triesLeft 0)
								(block ((angleOK true) strongholdAngle)
									(setq strongholdPos (sysVectorRandom firstStar bestDist 180 "T"))
									(setq strongholdAngle (sysVectorAngle strongholdPos firstStar))
									(enumWhile badAngles angleOK theBadAngle
										(if (leq -45 (mathAngleDiffDegrees theBadAngle strongholdAngle) 45)
											(setq angleOK Nil)
											)
										)
									(if angleOK
										(setq triesLeft 0)
										(setq triesLeft (- triesLeft 1))
										)
									)
								)
									
							; Create a different stronghold depending on the system level
							(switch
								(eq (sysGetLevel) 1)
									(setq strongholdType &stCharonPrimaryStronghold1;)

								(eq (sysGetLevel) 2)
									(setq strongholdType &stCharonPrimaryStronghold2;)

								(setq strongholdType &stCharonPrimaryStronghold3;)
								)

							; Create the stronghold
							(setq strongholdObj (sysCreateStation strongholdType strongholdPos))
							)
						)

					strongholdObj
					)
				))

			(setq chrOrderRaiders (lambda (frigateObj order orderTarget orderData)
				"Call shpOrder for all raiders following this leader"
				(enum (obj@ frigateObj 'raiderIDs) raiderID
					(shpOrder (objGetObjByID raiderID) order orderTarget orderData)
					)
				))

			(setq chrRaidTransport (lambda (transportObj homeBaseObj travelObj cargoValue)
				(block (distance lastNavPoint nextNavPoint travelTime roundTrip)
					; Figure out how many ticks it will take for the transport to
					; travel the distance
					(setq lastNavPoint homeBaseObj)
					(for i 1 50
						(block nil
							(setq nextNavPoint (sysGetNavPathPoint &svCorporate; homeBaseObj travelObj (* i 2)))
							(setq distance (+ distance (sysVectorDistanceExact lastNavPoint nextNavPoint)))
							(setq lastNavPoint nextNavPoint)
							)
						)
					(setq travelTime (sysCalcTravelTime distance (shpGetMaxSpeed transportObj)))
					(setq roundTrip (not (or (objMatches travelObj Nil "G")
											(objMatches homeBaseObj Nil "G")))
						)
					;(dbgOutput "Freighter travel time: " travelTime)

					(switch
						(leq cargoValue 25000)
							(block Nil
								; Raiding parties half way
								(sysAddEncounterEventAtDist 
									(divide (multiply (random 30 45) travelTime) 100)
									transportObj &etPirateAmbush1; 110
									)

								(sysAddEncounterEventAtDist 
									(divide (multiply (random 50 65) travelTime) 100)
									transportObj &etPirateAmbush1; 110
									)

								; 50% chance of a raiding party on the way back
								(if (and roundTrip (leq (random 1 100) 50))
									(sysAddEncounterEventAtDist 
										(divide (multiply (random 145 175) travelTime) 100)
										transportObj &etPirateAmbush1; 110
										)
									)
								)

						(leq cargoValue 50000)
							(block Nil
								; Raiding parties half way
								(sysAddEncounterEventAtDist 
									(divide (multiply (random 30 45) travelTime) 100)
									transportObj
									(random '(&etPirateAmbush1; &etPirateAmbush2;))
									110
									)

								(sysAddEncounterEventAtDist 
									(divide (multiply (random 50 65) travelTime) 100)
									transportObj
									(random '(&etPirateAmbush1; &etPirateAmbush2;))
									110
									)

								; 80% chance of a raiding party on the way back
								(if (and roundTrip (leq (random 1 100) 80))
									(sysAddEncounterEventAtDist 
										(divide (multiply (random 145 175) travelTime) 100)
										transportObj
										(random '(&etPirateAmbush1; &etPirateAmbush2;))
										110
										)
									)
								)

						(leq cargoValue 100000)
							(block Nil
								(if (leq (random 1 100) 50)
									; 50% of the time we send out a Drake missileship
									(chrDeployFrigateRaid transportObj homeBaseObj travelObj cargoValue &scDrake;)

									; 50% of the time we send out two raiding parties
									(block Nil
										(sysAddEncounterEventAtDist 
											(divide (multiply (random 25 40) travelTime) 100)
											transportObj
											&etPirateAmbush2;
											110
											)
										(sysAddEncounterEventAtDist 
											(divide (multiply (random 60 75) travelTime) 100)
											transportObj
											&etPirateAmbush2;
											110
											)
										)
									)

								; 60% chance of a raiding party on the way back
								(if (and roundTrip (leq (random 1 100) 60))
									(sysAddEncounterEventAtDist 
										(divide (multiply (random 145 175) travelTime) 100)
										transportObj
										&etPirateAmbush2;
										110
										)
									)
								)

						(leq cargoValue 250000)
							(block Nil
								; Send out a raiding party to weaken the transport
								(sysAddEncounterEventAtDist 
									(divide (multiply (random 25 35) travelTime) 100)
									transportObj &etPirateAmbush2; 110
									)

								; Send out a Drake missileship or frigate depending on cargo value
								(if (leq (random 100 200) (divide cargoValue 1000))
									(chrDeployFrigateRaid transportObj homeBaseObj travelObj cargoValue)
									(chrDeployFrigateRaid transportObj homeBaseObj travelObj cargoValue &scDrake;)
									)

								; 70% chance of a raiding party on the way back
								(if (and roundTrip (leq (random 1 100) 70))
									(sysAddEncounterEventAtDist 
										(divide (multiply (random 145 175) travelTime) 100)
										transportObj &etPirateAmbush2; 110
										)
									)
								)

						(leq cargoValue 500000)
							(block Nil
								; Send out a couple of raiding parties to weaken the transport
								(sysAddEncounterEventAtDist 
									(divide (multiply (random 25 35) travelTime) 100)
									transportObj
									(random '(&etPirateAmbush2; &etPirateAmbush3;))
									110
									)

								(sysAddEncounterEventAtDist 
									(divide (multiply (random 45 65) travelTime) 100)
									transportObj
									(random '(&etPirateAmbush2; &etPirateAmbush3;))
									110
									)

								; Send out a frigate
								(chrDeployFrigateRaid transportObj homeBaseObj travelObj cargoValue)

								; 80% chance of a raiding party on the way back
								(if (and roundTrip (leq (random 1 100) 80))
									(sysAddEncounterEventAtDist 
										(divide (multiply (random 145 175) travelTime) 100)
										transportObj &etPirateAmbush2; 110
										)
									)
								)

						(leq cargoValue 1000000)
							(block Nil
								; Send out a couple of raiding parties to weaken the transport
								(sysAddEncounterEventAtDist 
									(divide (multiply (random 25 35) travelTime) 100)
									transportObj &etPirateAmbush3; 110
									)

								(sysAddEncounterEventAtDist 
									(divide (multiply (random 45 65) travelTime) 100)
									transportObj &etPirateAmbush3; 110
									)

								; Send out a frigate
								(chrDeployFrigateRaid transportObj homeBaseObj travelObj cargoValue)

								; 90% chance of a raiding party on the way back
								(if (and roundTrip (leq (random 1 100) 90))
									(sysAddEncounterEventAtDist 
										(divide (multiply (random 145 175) travelTime) 100)
										transportObj &etPirateAmbush2; 110
										)
									)
								)

						(block Nil
							; Send out a three of raiding parties to weaken the transport
							(sysAddEncounterEventAtDist 
								(divide (multiply (random 25 35) travelTime) 100)
								transportObj &etPirateAmbush2; 110
								)

							(sysAddEncounterEventAtDist 
								(divide (multiply (random 45 65) travelTime) 100)
								transportObj &etPirateAmbush3; 110
								)

							(sysAddEncounterEventAtDist 
								(divide (multiply (random 45 65) travelTime) 100)
								transportObj &etPirateAmbush3; 110
								)

							; Send out a frigate
							(chrDeployFrigateRaid transportObj homeBaseObj travelObj cargoValue)

							; 100% chance of a raiding party on the way back
							(sysAddEncounterEventAtDist 
								(divide (multiply (random 145 175) travelTime) 100)
								transportObj &etPirateAmbush2; 110
								)
							)
						)
					)
				))
			)
	</Globals>

<!-- RESOURCES -->

	<Image UNID="&rsCharonFrigateHD;"		bitmap="Resources\CharonFrigateHD.jpg" bitmask="Resources\CharonFrigateHDMask.bmp" loadOnUse="true"/>


	<Image UNID="&rsCorsairHD;"				bitmap="Resources\CorsairHD.jpg" bitmask="Resources\CorsairHDMask.bmp"  loadOnUse="true"/>
	<Image UNID="&rsCorsairHero;"			bitmap="Resources\CorsairLarge.jpg" bitmask="Resources\CorsairLargeMask.bmp"  loadOnUse="true"/>

	<Image UNID="&rsDrakeHD;"				bitmap="Resources\DrakeHD.jpg" bitmask="Resources\DrakeHDMask.bmp" loadOnUse="true"/>
	<Image UNID="&rsDrakeHero;"				bitmap="Resources\DrakeLarge.jpg" bitmask="Resources\DrakeLargeMask.bmp" loadOnUse="true"/>

	<Image UNID="&rsVikingHD;"				bitmap="Resources\VikingHD.jpg" bitmask="Resources\VikingHDMask.bmp"  loadOnUse="true"/>
	<Image UNID="&rsVikingHero;"			bitmap="Resources\VikingLarge.jpg" bitmask="Resources\VikingLargeMask.bmp"  loadOnUse="true"/>

</TranscendenceModule>
