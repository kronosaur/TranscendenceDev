<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>

	<!-- Korolov Shipping

	Type holds all global data associated with Korolov Escort missions

	GLOBAL DATA
	
	record{shipUNID}:	Escort record for given freighter
							({successful} {unsuccessful})

	recordStrongholds:	Number of Charon primary strongholds destroyed

	-->

	<Type UNID="&unidKorolovShipping;">
		<Properties>
			<Definition id="rankTable">
				{
				0: {
					rank: 'none
					}
				1: {
					rank: 'apprentice
					icon: (resCreateImageDesc &rsKorolovInsignia; 0 0 120 120)
					xpNeeded: 0
					}
				2: {
					rank: 'journeyman
					icon: (resCreateImageDesc &rsKorolovInsignia; 120 0 120 120)
					xpNeeded: 300
					}
				3: {
					rank: 'master
					icon: (resCreateImageDesc &rsKorolovInsignia; 240 0 120 120)
					xpNeeded: 1500
					}
				4: {
					rank: 'legend
					icon: (resCreateImageDesc &rsKorolovInsignia; 360 0 120 120)
					xpNeeded: 3000
					condition: (lambda () (not (msnFind "r +korolov; +escort; +property:isFailure;")))
					}
				-1: {
					rank: 'blacklisted
					nextRank: -1
					}
				}
			</Definition>

			<Global id="rpg.rank"></Global>
			<Global id="rpg.xp">0</Global>

			<DynamicGlobal id="rankNoun">(rpgRankNoun gType)</DynamicGlobal>
			<DynamicGlobal id="rankIcon">
				(block (
					(rank (typ@ gType 'rpg.rank))
					(rankTable (typ@ gType 'rankTable))
					)
					(@ (@ rankTable rank) 'icon)
					)
			</DynamicGlobal>
			<Global id="escortSuccessCount">0</Global>
			<Global id="escortFailureCount">0</Global>

			<!--
				These properties check if the player
				has achieved certain non-rank
				milestones and been rewarded for them
				Nil = not achieved
				0 = achieved but reward not distributed yet
				1 = achieved and reward distributed
			-->

			<Global id="allSuccessInARow.3"></Global>
			<Global id="allSuccessInARow.10"></Global>

			<!--
				Sandbox mode is intended for sandbox-style
				adventures where the player is not required to
				keep moving.

				Sandbox mode enables:
					* escorting at legend rank
					* no hard limit on maximum escort missions

				Set it to a non-nil value to enable it.
			-->

			<Global id="sandboxMode"></Global>
		</Properties>

		<Events>
			<GetGlobalAchievements>
				(append
					;	Rank
					(rpgRankAchievements &unidKorolovShipping;)

					;	Missions
					(rpgMissionAchievements &unidKorolovShipping; "* +korolov; +escort;")
					)
			</GetGlobalAchievements>

			<OnGlobalUniverseLoad>
				(block (
					(transition (lambda (oldVar newVar)
						(if (typGetData gType oldVar)
							(block ()
								(typSet@ gType newVar (typGetData gType oldVar))
								(typSetData gType oldVar Nil)
								)
							)
						))
					)
					;	Transition data to properties
					(transition 'level 'rpg.rank)
					(transition 'xp 'rpg.xp)
					)
			</OnGlobalUniverseLoad>

			<OnPromotion>
				(block (
					(rank (typ@ gType 'rpg.rank))
					(roll (random 1 100))
					reward
					)
					;	Destroy all open freighter missions because now that we're a new
					;	level, the mission parameters will change

					(enum (msnFind gSource "oS +korolov; +escort;") theMission
						(msnDestroy theMission)
						)

					;	Handle reward

					(switch
						(= rank 2)
							(switch
								(and (leq roll 60)
										(= (objGetEquipmentStatus gPlayerShip 'SRSEnhancer) 'notInstalled)
										)
									(setq reward (itmCreate &itEnhanceSRSROM; 1))
								(and (leq roll 90)
										(= (objGetEquipmentStatus gPlayerShip 'TargetingComputer) 'notInstalled)
										)
									(setq reward (itmCreate &itTargetingComputerROM; 1))

								(setq reward (itmCreate &itEnhanceShieldsROM; 1))
								)

						(= rank 3)
							(setq reward (itmCreate &itClass5Deflector; 1))
						)
					(if reward (objAddItem gPlayerShip reward))

					(if (and (= rank 4) (not (typGetGlobalData &chVolkov; 'status)))
						{
							nextScreen: &dsRPGWingmanEncounter;
							nextScreenData: {wingman: &chVolkov;}
							})
					)
			</OnPromotion>
		</Events>

		<Language>
			<Text id="SuccessDebrief:FirstMission">
				
				"Excellent work, captain! You seem to have the aptitude to 
				handle these missions. Every time you successfully escort a 
				freighter you will earn money and increase your skills.
				
				"We've deposited %reward% in your account."
				
			</Text>
			<Text id="SuccessDebrief:Apprentice:1">
				(typTranslate gType (cat "textSuccessApprentice.1." (random 1 5)))
			</Text>
			<Text id="textSuccessApprentice.1.1">

				"Excellent work, captain! Your skills are improving rapidly.

				"During your apprenticeship you will escort small freighters 
				such as the EI100. When you become a Journeyman, you will be 
				rated to escort larger freighters with more valuable cargo.

				"We've deposited %reward% in your account."

			</Text>
			<Text id="textSuccessApprentice.1.2">

				"Excellent work, captain! Your skills are improving rapidly.

				"But here's some advice: Pirates seek out the most valuable 
				cargo; they'll send out larger and more powerful attacks against
				expensive cargos. Always be vigilant.

				"We've deposited %reward% in your account."

			</Text>
			<Text id="textSuccessApprentice.1.3">

				"Excellent work, captain! Your skills are improving rapidly.

				"But don't get cocky; escorting a fast EI200 or EI100 is much 
				easier than protecting a slow and defenseless Antares-class.

				"We've deposited %reward% in your account."

			</Text>
			<Text id="textSuccessApprentice.1.4">

				"Excellent work, captain! Your skills are improving rapidly.

				"But don't lower your guard; the pirates will keep 
				coming&mdash;at least until we wipe out their primary stronghold
				in the system.

				"We've deposited %reward% in your account."

			</Text>
			<Text id="textSuccessApprentice.1.5">

				"Excellent work, captain! Your skills are improving rapidly.

				"After a few more successful missions you will be ready for a 
				promotion to Journeyman&mdash;and ready for greater challenges!

				"We've deposited %reward% in your account."

			</Text>

			<Text id="SuccessDebrief:Apprentice:2">

				"Excellent work, captain! Your apprenticeship is almost complete.
				If you successfully complete the next escort mission, we'll be 
				confident in your skills and promote you.

				"We've deposited %reward% in your account."

			</Text>
			<Text id="SuccessDebrief:Apprentice:3">

				"Excellent work, captain! I knew from the beginning that you had
				the skills to succeed.

				"We've deposited %reward% in your account."

			</Text>
			<Text id="SuccessDebrief:Kronosaurus">

				"Your skills are truly impressive! But the news that you've 
				destroyed several Charon frigates has alarmed the pirates.

				"They're sending the Kronosaurus after you! It is the deadliest 
				frigate in the Charon fleet and it will not stop until you are 
				destroyed.

				"We've deposited %reward% in your account. You better spend 
				them wisely!"

			</Text>
			<Text id="SuccessDebrief:Default">

				"Well done, captain! You've shown skill and bravery in facing
				those pirates.

				"We've deposited %reward% in your account."

			</Text>

			<Text id="rpg.missionTypeDesc">Korolov shipping missions</Text>
			<Text id="rpg.rankTypeDesc">Korolov rank</Text>

			<Code id="rankDetails">
				(block (
					(rank (typ@ gType 'rpg.rank))
						
					(frigatesDestroyed (typGetGlobalData &scCharonFrigateRaider; 'totalDestroyed))
					(strongholdsDestroyed (typGetGlobalData gType 'recordStrongholds))
					)
					(if (gr rank 0)
						{
							title: (fmtNoun (typ@ gType 'rankNoun) 1 'titleCapitalize)
							largeIcon: (typ@ gType 'rankIcon)

							details: (append
								(list
									{
										title: (typTranslate gType 'labelTotal)
										desc: (typTranslate gType 'rtfValue {
											value: (+ (typ@ gType 'escortSuccessCount) (typ@ gType 'escortFailureCount))
											})
										}
									{
										title: (typTranslate gType 'labelSuccessRate)
										desc: (typTranslate gType 'rtfValue {
											value:
												(block (
													(successes (typ@ gType 'escortSuccessCount))
													(failures (typ@ gType 'escortFailureCount))
													(total (+ successes failures))
													)
													(if (gr total 0)
														(cat (round (* 100.0 (/ successes total))) "%")
														"0%"
														)
													)
											})
										}
									)

								(if (gr frigatesDestroyed 0)
									(list
										{
											title: (typTranslate gType 'labelFrigatesDestroyed)
											desc: (typTranslate gType 'rtfValue {
												value: frigatesDestroyed
												})
											}
										)
									)
								(if (gr strongholdsDestroyed 0)
									(list
										{
											title: (typTranslate gType 'labelStrongholdsDestroyed)
											desc: (typTranslate gType 'rtfValue {
												value: strongholdsDestroyed
												})
											}
										)
									)
								)

							detailsStyle: 'stats
							align: 'bottom
							}
						)
					)
			</Code>

			<Text id="rank.-1">blacklisted</Text>
			<Text id="rank.0">:a new pilot(s)</Text>
			<Text id="rank.1">:an apprentice(s)</Text>
			<Text id="rank.2">:a journeyman|journeymen</Text>
			<Text id="rank.3">:a master(s)</Text>
			<Text id="rank.4">:a legend(s)</Text>

			<Code id="rpg.descPromotion">
				(typTranslate gType (cat "descPromotion." (typ@ gType 'rpg.rank)) {
					AD: (rpgCharacterGetInfo gSource 'assistantDirector &chKorolovAssistantDirectors;)
					escortCount: (strNumber (count (msnFind "r +korolov; +escort; +property:isSuccess;")))
					})
			</Code>

			<Text id="descPromotion.1">

				"Korolov Shipping needs more pilots with your skills and
				determination. Please come back to us, or any other Korolov
				station, if you want to earn a bit of money."

			</Text>
			<Text id="descPromotion.2">

				"After reviewing your record, I have recommended to
				%titledName@AD%	that you be granted the rights and
				responsibilities of a Journeyman of the Korolov Shipping
				Corporation. Congratulations!

				"To aid you in your missions, please accept this ROM biosoft."

			</Text>
			<Text id="descPromotion.3">

				%titledName@AD%	talks to you after the mission:

				"You are one of our best pilots, and I'm happy to tell you that
				the executive board has promoted you to the rank of Master.
				Congratulations!

				"To commemorate this occasion, I want to give you this vintage
				deflector shield generator. May it help you in times of need."

			</Text>
			<Text id="descPromotion.4">

				A crowd gathers around you as you leave the debriefing;
				everyone reaches towards you in congratulations.

				"Congratulations! You've broken the record! You've escorted
				%escortCount% freighters without losing a single one!
				No one has accomplished that feat before!"

			</Text>

			<Text id="labelTotal">Total Escorts:</Text>
			<Text id="labelSuccessRate">Success Rate:</Text>
			<Text id="labelFrigatesDestroyed">Frigates Destroyed:</Text>
			<Text id="labelStrongholdsDestroyed">Strongholds Destroyed:</Text>

			<RTF id="rtfValue">{/rtf {/f:LargeBold;/c:#ffe667; %value%}}</RTF>

		</Language>
	</Type>

	<!-- Korolov Shipping

	EXTRA DATA

	charonStronghold:	Primary Charon base in the system

	-->

	<StationType UNID="&stKorolovShipping;"
			name=				": Korolov Shipping"
			sovereign=			"&svCorporate;"
			inherit=			"&baCorporateStation;"
				 
			attributes=			"corporate, corporateCustoms, corporateDecon, envAir, envEarth, envFire, envWater, friendly, generic, human, majorStation, korolovShipping, populated"
				 
			dockScreen=			"Dispatch"
			abandonedScreen=	"&dsRPGAbandonedStation;"

			level=				"4"
			size=				"390"
			armorID=			"&itPlasteelPlate;"
			hitPoints=			"630"
			multiHull=			"true"
			regen=              "6"
			shipRegen=			"6"
				 
			explosionType=		"&vtBlastExplosion3;"
			ejectaType=			"&vtWreckEjecta;"
			>

		<!-- Encounter Info -->

		<Encounter
				systemCriteria=			"+corporateSpace;"
				systemAffinity=			"+corporateCore;"
				levelFrequency=			"ccc-- ----- ----- ----- -----"

				locationCriteria=		"+planetary"
				enemyExclusionRadius=	"50"

				unique=					"inSystem"
				/>

		<!-- Properties -->

		<Properties>
			<Variant id="rpgCharacter.assistantDirector">
				(rpgCharacterRandom gSource "x +assistantDirector; +korolov;" 'assistantDirector)
			</Variant>
			<DynamicData id="missionReplenishDelay">
				(random
					;	min delay of 2 minutes
					(* 30 120)
					;	max delay of 5 minutes
					(* 30 300))
			</DynamicData>
			<Data id="maxRemainingMissions"></Data>
		</Properties>

		<!-- Trade and Items -->

		<Trade currency="credit">
			<Sell	criteria="m +commonwealth; +basicAmmo; -defective; -illegal; -notForSale; -notStandard;" priceAdj="100" inventoryAdj="200" levelFrequency="systemLevel:ruc|c|cur"/>
			<Sell	criteria="*NU -defective; -illegal; -notForSale; -notStandard;"	priceAdj="100"	noDescription="true"/>

			<Refuel			criteria="f +BasicFuel; L:1-5;" priceAdj="100"/>
			<RepairArmor	criteria="a L:1-8;" priceAdj="100"/>
			<ReplaceArmor	criteria="a L:1-8;" priceAdj="100"/>
			<InstallDevice	criteria="d L:1-6;" priceAdj="100"/>
			<RemoveDevice	criteria="d L:1-6;" priceAdj="100"/>
			<Decontaminate	criteria="*"		priceAdj="100"/>

			<BalanceTrade	criteria="{human.basicFood}"	impact="10"/>
			<BalanceTrade	criteria="{human.lux}"		impact="10"/>
			<BalanceTrade	criteria="{human.res}"		impact="10"/>
			<BalanceTrade	criteria="{core.ore}"			impact="5"/>

			<ConsumeTrade	criteria="{core.fusionFuel}"		impact="5"/>
		</Trade>
		
		<Items>
			<RandomItem count="1d4" criteria="r +commonwealth; -illegal; -military; -notForSale; -notStandard; L:3-6;"		levelFrequency="systemLevel:ru|c|curv"/>
		</Items>

		<!-- Configuration -->

		<!-- Satellites -->
		
		<Satellites>
			<Orbitals count="1d4" distance="2d8+6" angle="random">
				<Station type="&stSealedCargoContainer;"/>
			</Orbitals>
		</Satellites>

		<!-- Ships and Defenses -->
		
		<Ships>
			<Lookup count="1d2" table="&tbKorolovGuards;"/>
			<Lookup count="1d4+1" table="&tbKorolovFreighters;"/>
		</Ships>

		<!-- Image and Effects -->
		
		<Image			imageID="&rsKorolovShipping;" imageWidth="292" imageHeight="364"/>

		<DockingPorts>
			<Port x="-18"	y="128" />
			<Port x="100"	y="127" />
			<Port x="156"	y="31" />
			<Port x="165"	y="-45" />
			<Port x="98"	y="-75" />
			<Port x="120"	y="-153" />

			<Port x="0"		y="-162" />
			<Port x="-90"	y="-165" />
			<Port x="-103"	y="-82" />
			<Port x="-178"	y="-46" />
			<Port x="-113"	y="43" />
			<Port x="-98"	y="122" />
		</DockingPorts>

		<!-- Dock Screen -->

		<DockScreens>
			<Dispatch>
				<Display type="detailsPane">
					<OnDisplayInit>
						(typTranslate &unidKorolovShipping; 'rankDetails)
					</OnDisplayInit>
				</Display>

				<Panes>
					<Default descID="descWelcome">
						<OnPaneInit>
							(block (
								(playerLevel (typ@ &unidKorolovShipping; 'rpg.rank))
								)
								(switch
									(gr playerLevel 0)
										Nil

									(= playerLevel -1)
										(block ()
											(scrSetActionDesc gScreen 'actionDockServices (scrTranslate gScreen 'descNoDockServices.blacklisted))
											(scrEnableAction gScreen 'actionDockServices Nil)
											)

									(block ()
										(scrSetActionDesc gScreen 'actionDockServices (scrTranslate gScreen 'descNoDockServices.noRank))
										(scrEnableAction gScreen 'actionDockServices Nil)

										(scrShowAction gScreen 'actionServiceRecord Nil)
										)
									)
								)
						</OnPaneInit>

						<Actions>
							<Action id="actionInformation">
								(scrShowScreen gScreen &dsRPGDialog; (objTranslate gSource 'korolov.info))
							</Action>

							<Action id="actionOperations" default="1">
								(block (
									(playerLevel (typ@ &unidKorolovShipping; 'rpg.rank))
									theMission
									)
									;	If we've done enough escort missions we need to destroy any
									;	remaining open escort missions.

									(if (= (objGetData gSource 'remainingMissions) 0)
										(enum (msnFind gSource "oS +korolov; +escort;") theMission
											(msnDestroy theMission)
											)
										)

									(switch
										;	If we have an active mission from this station then we show it.

										(setq theMission (@ (msnFind gSource "aS +korolov;") 0))
											(scrShowScreen gScreen &dsRPGMission; {	missionObj: theMission })

										;	Check if we have any special (non-escort) missions

										(setq theMission (rpgMissionGetAssignment {
												missionCriteria: "n +korolov; -escort;"
												displayCriteria: "n +korolov; -escort;"
												}))
											(scrShowScreen gScreen &dsRPGMission; {	missionObj: theMission })

										;	Too many failures
										
										(= playerLevel -1)
											(scrShowScreen gScreen &dsRPGDialog; { desc:(scrTranslate gScreen 'descTooManyFailures) })

										;	Already a legend and not in sandbox mode
										
										(and (= playerLevel 4) (not (korIsSandboxMode)))
											(scrShowScreen gScreen &dsRPGDialog; { desc:(scrTranslate gScreen 'descAlreadyALegend) })
											
										;	If the main stronghold is destroyed and not in sandbox mode, no need for escorts
										
										(and (objIsAbandoned (objGetObjRefData gSource 'charonStronghold)) (not (korIsSandboxMode)))
											(scrShowScreen gScreen &dsRPGDialog; { desc:(scrTranslate gScreen 'descNoEscortsNeeded) })
											
										;	If we failed to destroy stronghold, we stop missions
										
										(objGetData gSource 'charonDominates)
											(scrShowScreen gScreen &dsRPGDialog; { desc:(scrTranslate gScreen 'descFreightersGrounded) })
											
										;	If the Charon Fortress is destroyed and not in sandbox mode, no missions
										
										(and (= (typGetGlobalData &stCharonPirateFortress; 'status) 'destroyed) (not (korIsSandboxMode)))
											(scrShowScreen gScreen &dsRPGDialog; { desc:(scrTranslate gScreen 'descFortressDestroyed) })
											
										;	If we're giving out escort missions, then show the list of
										;	freighters.
									
										(and (gr (objGetData gSource 'remainingMissions) 0))
											(scrShowScreen gScreen &dsKorolovEscortList;)
												
										;	Otherwise, nothing

										(scrShowScreen gScreen &dsRPGDialog; { desc:(scrTranslate gScreen 'descNoMissions) })
										)
									)
							</Action>

							<Action id="actionServiceRecord">
								(scrShowScreen gScreen 'ServiceRecord)
							</Action>

							<Action id="actionDockServices">
								(block (
									(playerLevel (typ@ &unidKorolovShipping; 'rpg.rank))
									)
									(switch
										(gr playerLevel 0)
											(rpgDockServices gPlayerShip)

										(scrShowScreen gScreen &dsRPGMessage; {
											desc: (scrTranslate gScreen 'descNoDockServicesAccess)
											})
										)
									)
							</Action>

							<Action id="actionUndock" cancel="1">
								<Exit/>
							</Action>
						</Actions>
					</Default>
				</Panes>
			</Dispatch>
			
			<ServiceRecord
				name=			"Situation Screen"
				backgroundID=	"none"
				>
				<OnScreenInit>
					(block (
						(shipList (sort (map (korFreighterTypes) theType {
								class:theType
								name:(shpGetClassName theType 0x080)
								level:(max (korTypGetMinLevel theType) 1)
								})
							'ascending 'name))
						(levelList (map (make 'sequence 3) level (filter shipList theShip (= (@ theShip 'level) level))))
						)
						(scrSetData gScreen 'nameList
							(join (map levelList theList (join (map theList theShip (@ theShip 'name)) "\n")) "\n\n")
							)
						(scrSetData gScreen 'levelList levelList)
						)
				</OnScreenInit>

				<Display>
					<Text left="140" top="24" right="-24" height="28" font="SubTitle" color="255,210,152">
						(plyComposeString gPlayer "%name%")
					</Text>

					<Image left="12" top="24" width="120" height="120" transparent="true">
						(typ@ &unidKorolovShipping; 'rankIcon)
					</Image>

					<Text left="140" top="52" right="-24" height="32" font="Large" color="200,206,199">
						(if (= (typ@ &unidKorolovShipping; 'rpg.rank) -1)
							"Dishonorably discharged"
							(cat (fmtNoun (typ@ &unidKorolovShipping; 'rankNoun) 1 'titleCapitalize) " in the Korolov Shipping Corporation")
							)
					</Text>

					<Text left="140" top="84" right="-24" height="18" font="MediumBold" color="255,210,152">
						"Service Record:"
					</Text>

					<Text left="140" top="102" right="280" bottom="-120" font="LargeBold" color="200,206,199">
						(scrGetData gScreen 'nameList)
					</Text>

					<Text left="280" top="102" right="-24" bottom="-120" font="Large" color="149,153,148">
						(join (map (scrGetData gScreen 'levelList) theList
								(join (map theList theShip (korEscortRecord (@ theShip 'class))) "\n")
								)
							"\n\n")
					</Text>

					<Text left="140" top="400" right="-24" height="18" font="MediumBold" color="255,210,152">
						(block (showText)
							(setq showText (gr (typGetData &unidKorolovShipping; 'recordStrongholds) 0))
							(if showText "Commendations:" "")
							)
					</Text>

					<Text left="140" top="416" right="-24" bottom="-12" font="Large" color="149,153,148">
						(block (
							(strongholdsDestroyed (typGetData &unidKorolovShipping; 'recordStrongholds))
							)

							(cat
								(switch
									(not strongholdsDestroyed)
										""

									(= strongholdsDestroyed 0)
										""

									(= strongholdsDestroyed 1)
										"Korolov Sign of Distinction for destroying a Charon stronghold.\n"

									(cat
										"Korolov Sign of Honor for destroying "
										(strNumber strongholdsDestroyed)
										" Charon strongholds.\n"
										)
									)
								)
							)
					</Text>
				</Display>

				<Panes>
					<Default>
						<OnPaneInit>
						</OnPaneInit>

						<Actions>
							<Action id="actionDone" cancel="1" default="1">
								(scrShowScreen gScreen 'Dispatch)
							</Action>
						</Actions>
					</Default>
				</Panes>
			</ServiceRecord>
		</DockScreens>

		<!-- Events and Data -->
		
		<Events>
			<OnCreate>
				(block (
						charonStronghold
						(remainingMissions (+ 3 (modulo (objGetDestiny gSource) 7)))
						)
					; Register a recurring event
					(sysAddObjRecurringTimerEvent 240 gSource "OnTrafficControl")

					; Allow a finite number of escort missions from each station
					(objSetData gSource 'remainingMissions remainingMissions)

					; Setup an event to check if we need to keep offering missions
					; in case sandbox mode gets turned on. Some gameplay code in
					; mods may only activate once the player loads in, or if the
					; player is using debug mods to toggle sandbox mode.
					(objSet@ gSource 'maxRemainingMissions remainingMissions)
					(sysAddObjTimerEvent (@ gSource 'missionReplenishDelay) gSource 'SandboxModeRefreshMissions)

					; Find the primary Charon stronghold in the system
					(setq charonStronghold (chrGetPrimaryStronghold gSource))
					(objSetObjRefData gSource "charonStronghold" charonStronghold)
					)
			</OnCreate>

			<OnDestroy>
				(block Nil
					(typFireObjEvent &baCorporateStation; gSource 'OnDestroy)
					(sysCancelTimerEvent gSource "OnTrafficControl")
					)
			</OnDestroy>

			<OnTrafficControl>
				(korTrafficControl gSource)
			</OnTrafficControl>
			
			<OnObjDocked>
				(if (and (eq aDockTarget gSource)
						(not (objGetProperty gSource 'abandoned))
						(objGetData aObjDocked 'korolov_traffic)
						)
					(block (theEscort)
						(if (setq theEscort (objGetObjRefData aObjDocked 'escortID))
							(block Nil
								(shpCancelOrders theEscort)
								(if (gr (objGetOpenDockingPortCount gSource) 1)
									(shpOrder theEscort 'guard gSource)
									(shpOrder theEscort 'gate)
									)
								(objSetData theEscort 'korolovEscort Nil)
								)
							)
						(objSetObjRefData aObjDocked 'escortID Nil)
						)
					)
			</OnObjDocked>

			<GetRumors>
				(block (
					(rank (typ@ &unidKorolovShipping; 'rpg.rank))
					)
					{
						attributes: "commonwealthPub"
						priority: 21
						textID: (switch
							(or (not rank) (= rank 0))	'rumor.commonwealthPub.norank
							(ls rank 0)					'rumor.commonwealthPub.blacklisted
														'rumor.commonwealthPub.member
							)
						data: {station: (objGetName gSource)}
						onExitRumor: (lambda (theRumor) (objSetKnown (@ theRumor 'sourceObj)))
						}
					)
			</GetRumors>

			<SandboxModeRefreshMissions>
				(if (korIsSandboxMode)
					(block ()
						;	Add a new mission if we dont have enough
						(if (ls (objGetData gSource 'remainingMissions) (obj@ gSource 'maxRemainingMissions))
							(objIncData gSource 'remainingMissions 1)
							)
						;	Set the next event
						(sysAddObjTimerEvent (@ gSource 'missionReplenishDelay) gSource 'SandboxModeRefreshMissions)
						)
					)
			</SandboxModeRefreshMissions>
		</Events>

		<Language>
			<Text id="actionInformation">[I]nformation</Text>
			<Text id="actionOperations">[O]perations Level</Text>
			<Text id="actionServiceRecord">[S]ervice Record</Text>
			<Text id="actionEnemyData">[E]nemy Intelligence</Text>
			<Text id="actionNext">[N]ext Ship</Text>
			<Text id="actionPrev">[P]revious Ship</Text>

			<Text id="descNoServiceRecord">You have no service record with the Korolov Shipping Corporation.</Text>

			<Text id="descNoDockServicesAccess">The dock services area is restricted to members only.</Text>

			<Text id="descNoDockServices.noRank">Complete a mission to access dock services</Text>
			<Text id="descNoDockServices.blacklisted">Access denied due to blacklist</Text>
			
			<Text id="descWelcome">
				(block (
					(level (typ@ &unidKorolovShipping; 'rpg.rank))
					)
					(cat
						(typTranslate gType 'descWelcomeStart) "\n\n"
						(switch
							(= level -1)
								(typTranslate gType 'descWelcome.blacklisted)

							(and (geq level 1) (leq level 4))
								(typTranslate gType (cat "descWelcome." level))

							(typTranslate gType 'descWelcome.1)
							)
						)
					)
			</Text>
			<Text id="descWelcomeStart">
				You are in the main hall of a Korolov Shipping Company station.
			</Text>
			<Text id="descWelcome.blacklisted">

				Conversations stop as you enter the room. Whispered 
				condemnations make it clear that you are not welcome among the 
				freighter crews and captains.

			</Text>
			<Text id="descWelcome.1">

				The walls are decorated with holopanes honoring the men and 
				women who died defending Korolov freighters.

			</Text>
			<Text id="descWelcome.2">

				The freighter captains welcome you as you enter.

			</Text>
			<Text id="descWelcome.3">

				The more experienced escort captains welcome you as you enter;
				you are treated with deference and respect.

			</Text>
			<Text id="descWelcome.4">

				Murmured excitement ripples across the hall as you enter; 
				everyone crowds around to greet you.

			</Text>

			<String id="descNoMissions">
				"Sorry, there are no missions currently available."
			</String>
			<Text id="descTooManyFailures">

				"Sorry, captain, but your escort record is terrible. 
				No freighter wants to be defended by you."

			</Text>
			<Text id="descAlreadyALegend">

				"Sorry, but Director Hammil doesn't want to risk your life. 
				The other shipping companies don't have a legendary pilot like you!"

			</Text>
			<Text id="descNoEscortsNeeded">

				"Sorry, there is no need for your escort skills now that the Charon base 
				in the system has been destroyed. I bet other systems could use your help, though."

			</Text>
			<Text id="descFreightersGrounded">

				"Sorry, all freighters are grounded. The Charon stronghold in 
				this system is too strong."

			</Text>
			<Text id="descFortressDestroyed">

				"Sorry, there is no need for your escort skills now that 
				the Fortress of the Charon Pirates has been destroyed."

			</Text>
			
			<Text id="descSelectOption">Select an option:</Text>

			<Text id="korolov.info">
				(list
					{	id: 'welcome
						descID: 'textInfo1
						actions: (list
							{	labelID: 'actionOurMission			nextPage:'ourMission	}
							{	labelID: 'actionFreighterData		nextPage:'code
								code: (lambda ()
									(scrShowScreen gScreen &dsRPGShipClassViewer; {
										list: (map (korFreighterTypes) theShip { shipClass:theShip })
										})
									)
								}

							{	labelID: 'actionEnemyIntel			nextPage:'code
								code: (lambda ()
									(scrShowScreen gScreen &dsRPGShipClassViewer; {
										list: (list

											;	NOTE: If you add items to the list, make sure
											;	you add a description in the Language section.

											{	shipClass:&scCorsair;	}
											{	shipClass:&scViking;	}
											{	shipClass:&scCorsair-II;	}
											{	shipClass:&scViking-II;	}
											{	shipClass:&scDrake;	}
											{	shipClass:&scCharonFrigateRaider;	}
											)
										})
									)
								}

							{	labelID: 'actionDone				nextPage:'exitScreen	}
							)
						}
					{	id: 'ourMission
						descID: 'textOurMission1		labelID: 'actionContinue
						}
					{	descID: 'textOurMission2		labelID: 'actionContinue	}
					{	descID: 'textOurMission3		labelID: 'actionDone	nextPage: 'welcome	}
					)
			</Text>
			<Text id="actionOurMission">[O]ur Mission</Text>
			<Text id="actionFreighterData">[F]reighter Data</Text>
			<Text id="actionEnemyIntel">[E]nemy Intelligence</Text>

			<Text id="textInfo1">

				The Korolov Shipping Corporation is largest and oldest shipping
				company in Human Space.

			</Text>
			<Text id="textOurMission1">

				Let's face it: most people don't consider interplanetary 
				shipping to be a sexy occupation. 3DV catalogs are filled with 
				the exploits of the Fleet or even the Commonwealth Militia, but 
				(other than the fringe series 'Antares Heavy') no one chronicles
				the day-to-day challenges of the lowly freighter or the men and 
				women who keep it safe.

				That's a shame because the life of a freighter escort captain 
				can be very exciting. In the less-populated systems of the New 
				Beyond, the dangers from pirates and outlaws can be extreme.
				
				Fighting off a wave of Corsair-class gunships while defending a 
				12-kiloton freighter requires sharp skills and a strong 
				protective instinct.
				
				And the pay is pretty good too.
			
			</Text>
			<Text id="textOurMission2">

				If you want to be an escort pilot for Korolov you'll want to 
				make sure you and your ship are ready. Lasers are probably the 
				best option against the kinds of threats you'll encounter, the
				bigger the better.
				
				But don't neglect your shields: Sometimes you'll need to 
				interpose yourself between the freighter you're protecting and 
				an incoming missile.

			</Text>
			<Text id="textOurMission3">
			
				To be a successful escort pilot you also need to do some 
				planning before you go out. The more valuable the cargo, the 
				more powerful the threat against it. Don't accept a request to 
				escort a cargo load beyond your abilities.
				
				At the same time, managers at Korolov like their escort pilots 
				to have wide-ranging experience. Make sure you escort a variety
				of freighters, from the tiny EI100s to the massive Antares Vs.
			
			</Text>
			<Text id="rpg.shipClassDescID">korolov.shipDesc</Text>
			<Text id="rpg.shipClassDesc.&scCorsair;">

				The backbone of the Charon Pirate fleet consists of these fast and
				deadly gunships. Piloted by young and somewhat inexperienced pirates,
				they are nonetheless dangerous in large numbers.

			</Text>
			<Text id="rpg.shipClassDesc.&scViking;">

				The Viking-class gunship is powerful and well-armored. It is slower
				than a Corsair, but more than fast enough to chase down a freighter.

			</Text>
			<Text id="rpg.shipClassDesc.&scCorsair-II;">

				More than an upgrade, the Corsair-II sports shields and a missile launcher.

			</Text>
			<Text id="rpg.shipClassDesc.&scViking-II;">

				The Viking-II is an upgraded version with shields and dual turbolasers.

			</Text>
			<Text id="rpg.shipClassDesc.&scDrake;">

				The Drake is the pirates' mobile battering ram. Heavily armored and loaded
				with missiles, the Drake will pummel you to pieces from long range.

			</Text>
			<Text id="rpg.shipClassDesc.&scCharonFrigateRaider;">

				The sight of these frigates brings fear to most freighter pilots. Fast,
				silent, and loaded with hurt, a Charon frigate can destroy a small fleet of
				escort ships. Do not challenge these ships unless you know what you're doing.

			</Text>

			<Text id="korolov.shipDesc.1454081">

				The backbone of the Charon Pirate fleet consists of these fast and
				deadly gunships. Piloted by young and somewhat inexperienced pirates,
				they are nonetheless dangerous in large numbers.

			</Text>
			<Text id="korolov.shipDesc.1454082">

				The Viking-class gunship is powerful and well-armored. It is slower
				than a Corsair, but more than fast enough to chase down a freighter.

			</Text>
			<Text id="korolov.shipDesc.1454083">

				More than an upgrade, the Corsair-II sports shields and a missile launcher.

			</Text>
			<Text id="korolov.shipDesc.134414405">

				The Viking-II is an upgraded version with shields and dual turbolasers.

			</Text>
			<Text id="korolov.shipDesc.134414404">

				The Drake is the pirates' mobile battering ram. Heavily armored and loaded
				with missiles, the Drake will pummel you to pieces from long range.

			</Text>
			<Text id="korolov.shipDesc.1454084">

				The sight of these frigates brings fear to most freighter pilots. Fast,
				silent, and loaded with hurt, a Charon frigate can destroy a small fleet of
				escort ships. Do not challenge these ships unless you know what you're doing.

			</Text>

			<Text id="rumor.commonwealthPub.norank">

				You spend 5 credits on drinks. You talk to a couple of freighter pilots
				who try to convince you to fly escort missions for Korolov Shipping.

			</Text>
			<Text id="rumor.commonwealthPub.blacklisted">

				A group of freighter pilots point in your direction, talking about how
				you blew your escort mission. You settle up a 5 credit tab and get ready
				to leave.

			</Text>
			<Text id="rumor.commonwealthPub.member">

				A group of freighter pilots welcome you into their group. You tell various
				stories about your run-ins with the Charon pirates, but in the end you still
				get stuck with the 5 credit tab.

			</Text>

			<Text id="core.mapDescMain">
				"Hires freighter escorts"
			</Text>
			<Code id="rpg.statusDetails">
				(typTranslate &unidKorolovShipping; 'rankDetails)
			</Code>
		</Language>
	</StationType>

<!-- DOCK SCREENS -->
	
	<!-- Escort Missions Available -->
	
	<DockScreen unid="&dsKorolovEscortList;"
			nestedScreen=		"true"
			inherit=			"&dsDockScreenBase;"
			>
		<OnScreenInit>
			(korInitMissions gSource)
		</OnScreenInit>
		
		<Display type="customPicker"
				rowHeight="80"
				iconWidth="128"
				iconHeight="80"
				iconScale="0.7"
				>
			<OnDisplayInit>
				(map (msnFind gSource "oS +korolov; +escort;") theMission 
					(block (
						(freighterObj (objGetObjByID (msnGetData theMission 'freighterID)))
						(freighterClass (msnGetData theMission 'escortType))
						)
						{
						title: (typGetProperty freighterClass 'name)
						icon: (shpGetImageDesc freighterClass 0)
						desc: (msnTranslate theMission 'listSummary)
					
						missionObj: theMission
						minLevel: (msnGetData theMission 'minPlayerLevel)
						minSpeed: (msnGetData theMission 'minPlayerSpeed)
						}
						)
					)
			</OnDisplayInit>
		</Display>
		
		<InitialPane>
			(switch
				(typ@ &unidKorolovShipping; 'rpg.rank)
					"Default"
				
				"EscortIntro"
				)
		</InitialPane>
		
		<Panes>
			<Default>
				<OnPaneInit>
					(block (
						(theEntry (scrGetListEntry gScreen))
						(theMission (@ theEntry 'missionObj))
						(playerLevel (typ@ &unidKorolovShipping; 'rpg.rank))
						(canAccept Nil)
						)
						(switch
							(not theEntry)
								(scrSetDescTranslate gScreen 'descNoMissions)
								
							;	If the player is not rated for this freighter, then
							;	there is nothing to do.
							
							(ls playerLevel (@ theEntry 'minLevel))
								(scrSetDescTranslate gScreen 'descNotRated)
								
							;	If the player is too slow to escort this freighter, then
							;	say so.
							
							(ls (shpGetMaxSpeed gPlayerShip) (@ theEntry 'minSpeed))
								(scrSetDescTranslate gScreen 'descTooSlow)
								
							;	Otherwise, OK
							
							(block ()
								(scrSetDesc gScreen (msnTranslate theMission 'Briefing))
								(setq canAccept True)
								)
							)
							
						(scrEnableAction gScreen 'actionEscortFreighter canAccept)
						)
				</OnPaneInit>
				
				<Actions>
					<Action id="actionEscortFreighter" default="1">
						(block (
							(theEntry (scrGetListEntry gScreen))
							(theMission (@ theEntry 'missionObj))
							)
							(scrExitScreen gScreen)
							(msnAccept theMission)
							(scrShowScreen gScreen &dsRPGMission; { missionObj:theMission status:'accept })
							)
					</Action>
					
					<Action id="actionCancel" cancel="1">
						(scrExitScreen gScreen)
					</Action>
				</Actions>
			</Default>
			
			<EscortIntro>
				<OnPaneInit>
					(block ()
						(scrSetDescTranslate gScreen
							(if (scrGetListEntry gScreen)
								'descOperationsIntro
								'descOperationsIntroNoFreighters
								)
							)

						;	Initialize our RPG Membership. We do this in case the player clicks on some
						;	freighter during EscortIntro.

						(rpgRankInit &unidKorolovShipping;)
						)
				</OnPaneInit>
				
				<Actions>
					<Action id="actionContinue">
						(scrShowPane gScreen 'Default)
					</Action>
				</Actions>
			</EscortIntro>
		</Panes>
		
		<Language>
			<Text id="actionEscortFreighter">[E]scort Freighter</Text>
			
			<Text id="descOperationsIntro">

				The operations level is filled with traffic controllers and ship captains
				coordinating freighter shipments across the system.
				
				A manager walks over to you: "There are some freighters looking for escorts. Check
				the display to your left."

			</Text>
			<Text id="descOperationsIntroNoFreighters">

				The operations level is filled with traffic controllers and ship captains
				coordinating freighter shipments across the system.
				
				A manager walks over to you: "All our freighters are out, but if you come back 
				later perhaps some will have returned."

			</Text>

			<Text id="descNoMissions">

				A manager walks over to you:

				"All our freighters are out, but if you come back later perhaps some will have
				returned."

			</Text>
			<Text id="descNotRated">

				You are not rated to escort this class of freighter.
				
				Once you gain experience escorting other freighters, you will
				be promoted.

			</Text>
			<Text id="descTooSlow">
				Unfortunately, your ship is too slow to escort this class of freighter.
			</Text>
			<Text id="descEscort">
				This freighter is looking for an escort.
			</Text>
		</Language>
	</DockScreen>

	<!-- Misc Rewards -->

	<DockScreen UNID="&dsKorolovMiscRewards;"
			nestedScreen=		"true"
			inherit=			"&dsDockScreenBase;"
			>
		<Properties>
			<Variant id="mission">(@ gData 'missionObj)</Variant>
			<Variant id="reward">(@ gData 'reward)</Variant>
		</Properties>

		<Display type="detailsPane">
			<OnDisplayInit>
				(or (@ gData 'rankDetails) (objTranslate gSource 'rpg.statusDetails))
			</OnDisplayInit>
		</Display>

		<Panes>
			<Default>
				<OnPaneInit>
					(switch
						(scrSetDescTranslate gScreen (scr@ gScreen 'reward) {
							AD: (rpgCharacterGetInfo gSource 'assistantDirector &chKorolovAssistantDirectors;)
							})
							Nil

						; if no reward we got here by mistake, or we were passed an unknown rewardName
						; just immediately go back to the previous screen
						; but leave a debug log for developers
						(block ()
							(dbgOutput (cat "Expected a korolov Miscellaneous reward called: " (scr@ gScreen 'reward)))
							(scrExitScreen gScreen)
							)
						)
				</OnPaneInit>

				<Actions>
					<Action id="actionContinue" default="1" cancel="1">
						(block (
							(missionObj (scr@ gScreen 'mission))
							(rewardName (scr@ gScreen 'reward))
							)
							(switch
								(= rewardName 'allSuccessInARow.3)
									(objAddItem gPlayership (itmCreate &itCashCardGold; 1))

								(= rewardName 'allSuccessInARow.10)
									(objAddItem gPlayership (itmCreate &itCashCardPlatinum; 1))
								)

							(typSet@ &unidKorolovShipping; rewardName 1)

							(scrExitScreen gScreen)

							;	Check if RPGMembership has set a next screen as we have
							;	bypassed the dsRPGMission check if we are here.
							(if (msnGetData missionObj 'rewardNextScreen)
								(scrShowScreen gScreen (msnGetData missionObj 'rewardNextScreen) (msnGetData missionObj 'rewardNextScreenData))
								)
							)
					</Action>
				</Actions>
			</Default>
		</Panes>

		<Language>
			<Text id="allSuccessInARow.3">

				"You're doing a good job out there! In recognition for successfully
				escorting three freighters without fail, we'd like for you to have
				this cash card."

			</Text>
			<Text id="allSuccessInARow.10">

				A small crowd of freighter and escord pilots gathers around as
				%titledName@AD% congratulates you:

				"You have escorted ten freighters without losing any of them!
				I am proud to reward you with this platinum cash card for a job
				well done!"

				%titledName@AD% hands you the cash card as the crowd applauds.

			</Text>
		</Language>
	</DockScreen>

<!-- BASE CLASSES -->
	
	<!-- Korolov Freighter -->

	<Type UNID="&evKorolovFreighterBehavior;">
		<Communications>
			<Message id="msgStatus" name="Status" key="S">
				<OnShow>
					(objGetData gSource 'korolovPlayerEscort)
				</OnShow>
				<Invoke>
					(block (
						(damageDesc (objGetProperty gSource 'damageDesc))
						(shieldLevel (@ damageDesc 'shieldLevel))
						(armorLevel (@ damageDesc 'armorIntegrity))
						(hullLevel (@ damageDesc 'hullIntegrity))
						)
						(objSendMessage gSender gSource
							(switch
								(and hullLevel (ls hullLevel 100))
									(objTranslate gSource 'msgHullDamage damageDesc)
									
								(and armorLevel (ls armorLevel 100))
									(objTranslate gSource 'msgArmorDamage damageDesc)
									
								(and shieldLevel (ls shieldLevel 100))
									(objTranslate gSource 'msgShieldDamage damageDesc)
									
								(objTranslate gSource 'msgNoDamage)
								)
							)
						)
				</Invoke>
			</Message>
		</Communications>

		<Events>
			<OnEventHandlerInit>
				(sysAddObjRecurringTimerEvent 60 gSource 'OnBehavior)
			</OnEventHandlerInit>

			<OnCreate>
				(block (
					; If aBaseObj is not defined then look for a korolovShipping station
					(homeObj (if aBaseObj aBaseObj (sysFindObject Nil "TN +korolovShipping;")))
					)
					(objSetData gSource 'korolov_traffic True)
					(objSetData gSource 'home (objGetID homeObj))
					(shpOrder gSource 'dock homeObj)
					)
			</OnCreate>

			<OnBehavior>
				(switch
					(not (objGetData gSource 'korolovPlayerEscort))
						Nil

					(geq (objGetData gSource 'nextMsg) (unvGetTick))
						Nil

					(geq (objGetDistance gSource gPlayerShip) 100)
						(block Nil
							(objSendMessage gPlayerShip gSource "Form Up!")
							(objSetData gSource "nextMsg" (add (unvGetTick) 300))
							)
					)
			</OnBehavior>

			<OnDockObjDestroyed>
				;	If a station that we're docked with got destroyed, then we 
				;	need to react.

				(switch
					;	If we're being escorted by the player, don't do anything
					;	(Let the mission handle it).

					(objGetData gSource 'korolovPlayerEscort)
						Nil

					;	If the station destroyed was our home base, then we just 
					;	gate out.

					(= (objGetID aObjDestroyed) (objGetData gSource 'home))
						(block ()
							(shpCancelOrders gSource)
							(shpOrder gSource 'gate)
							(objSetObjRefData gSource 'korolovDest Nil)
							)

					;	Otherwise, return home

					(block (
						(homeObj (objGetObjByID (objGetData gSource 'home)))
						)
						(shpCancelOrders gSource)
						(shpOrder gSource 'dock homeObj)
						(objSetObjRefData gSource 'korolovDest Nil)
						)
					)
			</OnDockObjDestroyed>
			
			<OrderTraffic>
				(block (
					(homeObj (objGetObjByID (objGetData gSource 'home)))
					(theEscort (random (sysFindObject homeObj "sHZ O:guard;")))
					(dest (objGetObjRefData gSource 'korolovDest))
					(altDest (random (sysFindObject homeObj "TAF +populated; -occupation; -uncharted; -outlaws;")))
					(missionObj (objGetObjByID (objGetData gSource 'missionID)))
					)
					(switch
						; If we have a preset destination then use that
						dest
							Nil

						; We leave the system: 30% of the time; or if home base is too crowded; or if there is no where else to go
						(or (leq (random 1 100) 30) (not altDest) (= (objGetOpenDockingPortCount homeObj) 0))
							(setq dest (random (sysFindObject homeObj "G -uncharted;")))

						; The rest of the time, we dock at a station and return
						(setq dest altDest)
						)
						
					;	Order

					(if (objMatches dest Nil "G")
						(block Nil
							(shpCancelOrders gSource)
							(shpOrder gSource 'gate dest)
							(objSetObjRefData gSource 'korolovDest Nil)
							)

						(block Nil
							(shpCancelOrders gSource)
							(shpOrder gSource 'dock dest)
							(shpOrder gSource 'waitForThreat Nil (random 5 12))
							(shpOrder gSource 'dock homeObj)
							(objSetObjRefData gSource 'korolovDest Nil)
							)
						)

					;	If there is a mission attached, then we're done with this mission
					
					(if missionObj
						(msnDestroy missionObj)
						)
						
					; Send an escort too
					(if theEscort
						(block Nil
							(shpCancelOrders theEscort)
							(shpOrder theEscort 'escort gSource)
							(objSetData theEscort 'korolovEscort True)
							(objSetObjRefData gSource 'escortID theEscort)
							(objRegisterForEvents homeObj gSource)
							)
						; If we have no escorts, then we need some
						(objSetData homeObj 'needEscorts True)
						)
					)
			</OrderTraffic>
		</Events>
		
		<Language>
			<String id="msgNoDamage">No damage</String>
			<String id="msgArmorDamage">Armor integrity at %armorIntegrity%%</String>
			<String id="msgShieldDamage">Shields at %shieldLevel%%</String>
			<String id="msgHullDamage">Hull integrity at %hullIntegrity%%</String>
		</Language>
	</Type>

<!-- GLOBALS -->

	<Globals>
		(block Nil
			(setq korTypGetMinLevel (lambda (typ)
				"Get the minimum rank required for escorting this type"
				(switch
					;	New method via properties
					(typ@ typ 'korolov.cargoValue.0)
						0
					(typ@ typ 'korolov.cargoValue.1)
						1
					(typ@ typ 'korolov.cargoValue.2)
						2
					(typ@ typ 'korolov.cargoValue.3)
						3
					(typ@ typ 'korolov.cargoValue.4)
						4

					;	Legacy method
					(typ@ typ 'korolovMinLevel)
					)
				))

			(setq korObjGetMinLevel (lambda (obj)
				"Get the minimum rank required for escorting this object"
				(switch
					;	New method via properties
					(obj@ obj 'korolov.cargoValue.0)
						0
					(obj@ obj 'korolov.cargoValue.1)
						1
					(obj@ obj 'korolov.cargoValue.2)
						2
					(obj@ obj 'korolov.cargoValue.3)
						3
					(obj@ obj 'korolov.cargoValue.4)
						4

					;	Legacy method
					(obj@ obj 'korolovMinLevel)
					)
				))

			(setq korIsSandboxMode (lambda ()
				"Returns a non-nil value if sandbox mode is enabled"
				(typ@ &unidKorolovShipping; 'sandboxMode)
				))

			(setq korRandomCargoValue (lambda (min max)
				"Returns standard distribution of cargo values from min to max"
				(randomGaussian
					min
					(+ min (int (/ (- max min) 2)))
					max
					)
				))

			;	korInitMissions
			;
			;	Initializes missions for every freighter docked at the station and missions
			;	for escorting new freighters from stargate. This may be called multiple time;
			;	we make sure everything is initialized and only create new missions as needed.
			
			(setq korInitMissions (lambda (homeObj)
				(block (
					)
					
					;	Make sure every docked freighter has a mission attached.
				
					(enum (sysFindObject homeObj "sHZ O:docked; D:korolov_traffic;") freighterObj
						(if (not (objGetObjByID (objGetData freighterObj 'missionID)))
							(msnCreate &msKorolovEscort; homeObj { freighterObj:freighterObj })
							)
						)
				
					;	If we don't have a mission for an incoming freighter, then
					;	create one.
				
					(if (not (msnFind homeObj "oS +unid:&msKorolovNewFreighter;;"))
						(msnCreate &msKorolovNewFreighter; homeObj)
						)
					)
				))
			
			; Korolov Traffic Control
			; EXTRA DATA
			; needEscorts:		TRUE if we launch a freighter without escorts.
			(setq korTrafficControl (lambda (homeObj)
				(block (
					(dockedFreighters (sysFindObject homeObj "sHZ O:docked; D:korolov_traffic;"))
					(freighterCount (count (sysFindObject homeObj "s D:korolov_traffic;")))
					(freightersInFlight (- freighterCount (count dockedFreighters)))
					(escorts (sysFindObject homeObj "sHZ O:guard;"))
					(escortsInFlight (filter (sysFindObject homeObj "s D:korolovEscort;") escort (objGetData escort 'korolovEscort)))
					(escortCount (+ (count escorts) (count escortsInFlight)))
					(portsLeft (gr (objGetOpenDockingPortCount homeObj) 0))
					)

					; Exclude freighters being escorted by the player
					(setq dockedFreighters (filter dockedFreighters theFreighter
						(not (objGetData theFreighter 'korolovPlayerEscort))
						))

					; If we don't have enough escorts, then we better get some more
					(if (and portsLeft
							(or
								(and (ls escortCount 3) (= (random 1 5) 1))
								(and (objGetData homeObj 'needEscorts) (= (random 1 3) 1))
								)
							)
						(block (newShip)
							(setq newShip
								(sysCreateShip
									&tbKorolovEscorts;
									(objGetNearestStargate homeObj)
									&svCorporate;
									)
								)
							(shpOrder newShip 'guard homeObj)
							(objSetData homeObj 'needEscorts Nil)
							)
						)

					; If we don't have enough freighters, then we ask for some
					(if (and portsLeft
							(or (ls freighterCount 2)
								(and (ls freighterCount 3) (= (random 1 3) 1))
								(and (ls freighterCount 6) (= (random 1 17) 1)))
							)
						(sysCreateShip
							(random (append (korFreighterTypes 1) (korFreighterTypes)))
							(objGetNearestStargate homeObj)
							&svCorporate;
							&evKorolovFreighterBehavior;
							)
						)

					; Send out a freighter to a random station
					(switch
						; If we have no ports left, then send some escorts away
						(and (not portsLeft) escorts)
							(block (theCount)
								(setq theCount (max 1 (subtract (count escorts) 5)))
								(for i 1 theCount
									(block (theEscort)
										(setq theEscort (item escorts (subtract i 1)))
										(shpCancelOrders theEscort)
										(shpOrder theEscort 'gate)
										)
									)
								)

						; Must have freighters
						(not dockedFreighters)
							Nil

						; If failed to destroy charon stronghold then we hold
						(and (objGetData homeObj 'charonDominates) portsLeft)
							Nil

						; If we're in the middle of attack stronghold, then we hold
						(and (msnFind gSource "aS +unid:&msKorolovKillStronghold;;") portsLeft)
							Nil

						; If the player is docked, then we don't do anything
						(and (objIsDockedAt gPlayerShip homeObj) portsLeft)
							Nil

						; If we're under attack, then we don't do anything
						(objIsUnderAttack homeObj)
							Nil

						; If we don't have enough freighters, then don't worry
						(and (ls (count dockedFreighters) 3) portsLeft)
							Nil

						; Random interval
						(and (gr (random 1 6) 1) portsLeft)
							Nil

						; Otherwise, send out a random freighter
						(objFireEvent (random dockedFreighters) 'OrderTraffic)
						)
					)
				))

			(setq korComputePlayerLevel (lambda ()
				;	DEPRECATED
				(block (
					(xp (typGetData &unidKorolovShipping; 'xp))
					(totalMissionsFailed (count (msnFind "r +korolov; +escort; +property:isFailure;")))
					)
					(switch
						(ls xp 0)						-1
						(ls xp 300)						1
						(ls xp 1500)					2
						(ls xp 3000)					3
						(gr totalMissionsFailed 0)		3
														4
						)
					)
				))

			(setq korGetPlayerLevel (lambda ()
				(or (typ@ &unidKorolovShipping; 'rpg.rank) 0)
				))

			(setq korSuccessDebrief (lambda (missionObj)
				(block (
					(level (typ@ &unidKorolovShipping; 'rpg.rank))
					(xp (typ@ &unidKorolovShipping; 'rpg.xp))
					(data {
						reward: (fmtCurrency 'credit (msn@ gSource 'reward))
						})
					)
					(switch
						; Describe a bit the process after the player's first mission
						(= (count (msnFind "r +korolov;")) 1)
							(typTranslate &unidKorolovShipping; "SuccessDebrief:FirstMission" data)

						; At the next level
						(and (= level 1) (geq xp 300))
							(typTranslate &unidKorolovShipping; "SuccessDebrief:Apprentice:3" data)

						; If we're about to become a journeyman, tell the player
						(and (= level 1) (geq xp 225))
							(typTranslate &unidKorolovShipping; "SuccessDebrief:Apprentice:2" data)

						; At level 1, describe the things to look forward to
						(= level 1)
							(typTranslate &unidKorolovShipping; "SuccessDebrief:Apprentice:1" data)

						; If the Kronosaurus has been deployed, warn player
						(msnGetData missionObj 'kronosaurusWarning)
							(typTranslate &unidKorolovShipping; "SuccessDebrief:Kronosaurus" data)

						; Standard text
						(typTranslate &unidKorolovShipping; "SuccessDebrief:Default" data)
						)
					)
				))

			(setq korGiveReward (lambda (missionObj)
				;	DEPRECATED
				(block (oldRank newRank)
					(rpgMissionRewardPayment (msnGetData missionObj 'reward))
					(typIncData &unidKorolovShipping; 'xp (msnGetData missionObj 'missionXP))

					;	If the player has destroyed 3 frigates, try deploying the Kronosaurus
					;	NOTE: chrDeployKronosaurus will return Nil if the Kronosaurus is already
					;	dead.

					(if (geq (typGetGlobalData &scCharonFrigateRaider; 'totalDestroyed) 3)
						(msnSetData missionObj 'kronosaurusWarning (chrDeployKronosaurus))
						)

					;	Check to see if we've been promoted
					;
					;	NOTE: In some cases korComputePlayerLevel will return a lower level than
					;	the player's current level. This can happen because killing the Kronosaurus
					;	automatically brings the player up to level 4, even if they've previously
					;	failed a mission (which forces a cap at level 3).

					(setq oldRank (korGetPlayerLevel))
					(setq newRank (korComputePlayerLevel))
					(if (gr newRank oldRank)
						;	If we need to rank up, show that screen
						(block Nil

							;	dsRPGMission checks for a well-known data member in the mission
							;	object to see if it should navigate to an additional screen.
							;	dsKorolovPromotion handles checking if we need to hand out other
							;	minor rewards first
							(if missionObj
								(msnSetData missionObj 'rewardNextScreen &dsKorolovPromotion;)
								)

							;	Set the new rank
							(typSetData &unidKorolovShipping; 'level newRank)
							)
						)
						;	otherwise check if we need to give a miscellaneous reward
						(if (korGetPendingMiscAward)
								(msnSetData missionObj 'rewardNextScreen &dsKorolovMiscRewards;)
							)
					)
				))

			(setq korGetPendingMiscAward (lambda ()
				(switch
					;	We can be called directly from OnGetNextScreen, so make sure this
					;	is actually during Mission Success.
					(!= aScreenType 'SuccessFollowUp)
						Nil

					; We check if any reward is at state 0, which means that the
					; reward is pending but not awarded yet
					(= (typ@ &unidKorolovShipping; 'allSuccessInARow.3) 0)
						{
							nextScreen: &dsKorolovMiscRewards;
							nextScreenData: {
								missionObj: gSource
								reward: 'allSuccessInARow.3
								}
						}

					(= (typ@ &unidKorolovShipping; 'allSuccessInARow.10) 0)
						{
							nextScreen: &dsKorolovMiscRewards;
							nextScreenData: {
								missionObj:gSource
								reward: 'allSuccessInARow.10
								}
						}
					)
				))

			(setq korEscortMissionCompleted (lambda (missionObj reason data)
				(block (
					(recordID (cat "record" (msnGetData missionObj 'escortType)))
					(transRecord (typGetData &unidKorolovShipping; recordID))
					;	Note that the current mission is not counted in this yet
					(totalMissionsSuccess (count (msnFind "r +korolov; +escort; +property:isSuccess;")))
					(totalMissionsFailed (count (msnFind "r +korolov; +escort; +property:isFailure;")))
					(xpBonus Nil)
					)
					; Decrease the number of missions available at the source station
					(objIncData (objGetObjByID (msnGetProperty missionObj 'ownerID)) 'remainingMissions -1)

					(if (not transRecord) (setq transRecord (list 0 0)))
					(switch
						(= reason 'success)
							(block Nil
								(typInc@ &unidKorolovShipping; 'escortSuccessCount 1) 
								(lnkReplace transRecord 0 (+ (@ transRecord 0) 1))
								(unvSetAchievement 'humanSpace.korolovEscort)
								(if (and (not (typ@ &unidKorolovShipping; 'allSuccessInARow.3)) (geq (+ totalMissionsSuccess 1) 3) (= totalMissionsFailed 0))
									(typSet@ &unidKorolovShipping; 'allSuccessInARow.3 0) 
									)
								(if (and (not (typ@ &unidKorolovShipping; 'allSuccessInARow.10)) (geq (+ totalMissionsSuccess 1) 10) (= totalMissionsFailed 0))
									(typSet@ &unidKorolovShipping; 'allSuccessInARow.10 0) 
									)
								)

						(and (= reason 'failure) (msnGetData missionObj 'playerDestroyedFreighter))
							(block Nil
								(typInc@ &unidKorolovShipping; 'escortFailureCount 1) 
								(lnkReplace transRecord 1 (+ (@ transRecord 1) 1))
								(typSetData &unidKorolovShipping; 'level -1)
								(typSetData &unidKorolovShipping; 'xp -1)
								)

						(= reason 'failure)
							(block Nil
								(typInc@ &unidKorolovShipping; 'escortFailureCount 1) 
								(lnkReplace transRecord 1 (+ (@ transRecord 1) 1))
								(setq xpBonus
									(switch
										(= totalMissionsFailed 0) 0
										(= totalMissionsFailed 1) -50
										(= totalMissionsFailed 2) -100
										-200
										)
									)
								)
						)

					(if xpBonus (typIncData &unidKorolovShipping; 'rpg.xp xpBonus))
					(typSetData &unidKorolovShipping; recordID transRecord)
					)
				))

			(setq korEscortRecord (lambda (shipClass)
				(block (
					(transRecord (typGetData &unidKorolovShipping; (cat "record" shipClass)))
					(successes (@ transRecord 0))
					(failures (@ transRecord 1))
					(totalMissions (+ successes failures))
					(minLevel (korTypGetMinLevel shipClass))
					)
					(switch
						(and transRecord (= failures 0))
							(cat successes " successful " (if (gr successes 1) "missions" "mission"))

						(and transRecord (= successes 0))
							(cat failures " failed " (if (gr failures 1) "missions" "mission"))

						(and transRecord (!= totalMissions 0))
							(cat successes " out of " totalMissions " successful missions (" (divide (multiply 100 successes) totalMissions) "%)")

						(gr minLevel (korGetPlayerLevel))
							"Not rated to escort this class"

						"No missions completed"
						)
					)
				))

			(setq korFreighterTypes (lambda (maxLev)
				"Return a list of ShipClasses to use as Korolov freighters"
				(block (
					(lev (if maxLev maxLev 999))
					)
					(filter
						(typFind "s +freighter")
						typ
						(and
							(korTypGetMinLevel typ)
							(geq lev (korTypGetMinLevel typ))
							)
						)
					)
				))

			(setq korEmptyFreighter (lambda (freighterObj)
				(block Nil
					(enum (objGetItems freighterObj "*U~m -ID;") theItem
						(objRemoveItem freighterObj theItem)
						)
					)
				))

			(setq korFillFreighter (lambda (freighterObj pricePerContainer)
				(block (container fitCount)
					(setq container (itmSetCharges (itmCreate &itKorolovShippingContainer; 1) (divide pricePerContainer 25)))
					(setq fitCount (objGetFitCount freighterObj (itmSetCount container 100000)))
					
					(objAddItem freighterObj container fitCount)

					; Return the total value of the cargo
					(multiply fitCount (itmGetActualPrice container))
					)
				))

			(setq korCalculateCargo (lambda (escortType escortLevel oneWay)
				"Calculate the cargo value and escort fees for a Korolov freighter"
				(block (
					(escortRate (or
						;	New method
						(typ@ escortType 'korolov.escortRate)

						(typGetStaticData escortType 'korolovEscortRate)
						))
					(fitCount (/ (typGetProperty escortType 'cargoSpace) 25))
					pricePerContainer cargoValue escortFee
					)

					;	Figure out the price per container of the cargo
					(setq pricePerContainer (or
						;	New method
						(/ (typ@ escortType (cat 'korolov.cargoValue. escortLevel)) fitCount)

						;	1.8-1.9 method
						(eval (@ (typGetStaticData escortType 'korolov.containerPrice) escortLevel))

						;	Legacy method (1.7 and before)
						(block Nil
							(typSetData &stKorolovShipping; 'level escortLevel)
							(eval (typGetStaticData escortType 'korolovContainerPrice))
							)

						;	Otherwise aim for a suitable cargoValue
						(/ (* (@ '(25 75 150 300 600) escortLevel) 1000) fitCount)
						))

					(setq cargoValue (* pricePerContainer fitCount))

					;	Compute the fee that we will pay for escort based on the value of the
					;	cargo and the rate that the freighter will pay
					(setq escortFee (/ (* (if (gr escortRate 0) escortRate 100) cargoValue) 10000))

					;	Reduce fee for one-way trip
					(if oneWay (setq escortFee (/ (* escortFee 65) 100)))

					;	Adjust the fee randomly and round down to the nearest 50
					(setq escortFee (intRoundDown (/ (* escortFee (random 75 125)) 100) 50))

					{
						escortFee: escortFee
						cargoValue: cargoValue
						pricePerContainer: pricePerContainer
						}
					)
				))

			(setq korFrigateDestroyed (lambda ()
				(if (gr (typGetData &unidKorolovShipping; 'xp) 0)
					(typIncData
						&unidKorolovShipping;
						'xp
						(@ '(0 500 250 150) (typGetGlobalData &scCharonFrigateRaider; "totalDestroyed"))
						)
					)
				))

			(setq korOnShipDestroyed (lambda ()
				(block (theWitness)
					(if (and aOrderGiver 
							(eq aOrderGiver gPlayerShip)
							(eq (sovGetDisposition &svCommonwealth; (objGetSovereign gSource)) 'friend)
							(not (sysFindObject gPlayerShip "sTAE N:100"))
							(not (objGetData gSource "noPiracyCheck"))
							(setq theWitness (random 
								(filter (sysFindObject gSource "sTAF Z N:100; -auton; -zoanthrope; -nonInterference;") theObj 
									(and (objCanDetectTarget theObj gSource)
										(objCanDetectTarget theObj gPlayerShip)
										(not (typHasAttribute (objGetSovereign theObj) 'nonInterference))
										(not (objGetProperty theObj 'playerWingman))
										(or (not (eq (shpGetOrder theObj) 'escort))
											(not (eq (shpGetOrderTarget theObj) gPlayerShip))
											)
										)
									)
								))
							)
						(block Nil
							(objSendMessage gPlayerShip theWitness "Pirate!")
							(intCommonwealthCrime 2 "piracy")
							)
						)
					)
				))
			)
	</Globals>

<!-- TABLES -->

	<ShipTable unid="&tbKorolovEscorts;">
		<LevelTable>
			<Ship levelFrequency="cur-- -----"	class="&scRoninB;"	/>
			<Ship levelFrequency="uccr- -----"	class="&scRoninC;"	/>
			<Ship levelFrequency="-rucr -----"	class="&scWolfenC;"	/>
			<Ship levelFrequency="--ruc r----"	class="&scCenturionBlock1;"	/>
			<Ship levelFrequency="---ru crvvv"	class="&scCenturionBlock2;"	/>
		</LevelTable>
	</ShipTable>

	<ShipTable unid="&tbKorolovGuards;">
		<LevelTable>
			<Ship levelFrequency="cur-- -----"	class="&scRoninB;"	/>
			<Ship levelFrequency="uccr- -----"	class="&scRoninC;"	/>
			<Ship levelFrequency="-rucr -----"	class="&scWolfenC;"	/>
			<Ship levelFrequency="--ruc r----"	class="&scCenturionBlock1;"	/>
			<Ship levelFrequency="---ru crvvv"	class="&scCenturionBlock2;"	/>
		</LevelTable>
	</ShipTable>

	<ShipTable unid="&tbKorolovFreighters;">
		<LevelTable>
			<Ship levelFrequency="cur-- -----"	class="&scAntaresI;"	eventHandler="&evKorolovFreighterBehavior;"/>
			<Ship levelFrequency="uccrv vvvvv"	class="&scAntaresII;"	eventHandler="&evKorolovFreighterBehavior;"/>
			<Ship levelFrequency="ruccu urrrr"	class="&scAntaresV;"	eventHandler="&evKorolovFreighterBehavior;"/>
			<Ship levelFrequency="curv- -----"	class="&scEI100;"	eventHandler="&evKorolovFreighterBehavior;"/>
			<Ship levelFrequency="uccur v----"	class="&scEI200;"	eventHandler="&evKorolovFreighterBehavior;"/>
			<Ship levelFrequency="ruccu urrrr"	class="&scEI7000;"	eventHandler="&evKorolovFreighterBehavior;"/>
			<Ship levelFrequency="ruccu uurrr"	class="&scScarabFreighterKorolov;"	eventHandler="&evKorolovFreighterBehavior;"/>
			<Ship levelFrequency="uccur v----"	class="&scT31ArmedTransportKorolov;"	eventHandler="&evKorolovFreighterBehavior;"/>
			<Ship levelFrequency="vrccu rrvvv"	class="&scT55ArmedTransportKorolov;"	eventHandler="&evKorolovFreighterBehavior;"/>
		</LevelTable>
	</ShipTable>
	
<!-- CHARACTERS -->

	<Type unid="&chKorolovAssistantDirectors;"
			attributes="assistantDirector, korolov"
			>
		<StaticData>
			<Data id="characterTable">
				{
					ash: {
						id: 'ash
						fullName: "Theodore Ash"
						formalName: "AD Ash"
						titledName: "Assistant Director Ash"
						genome: 'human
						gender: 'genderMale
						}

					burke: {
						id: 'burke
						fullName: "Saladin Burke"
						formalName: "AD Burke"
						titledName: "Assistant Director Burke"
						genome: 'human
						gender: 'genderMale
						}

					czerniawski: {
						id: 'czerniawski
						fullName: "Lori Czerniawski"
						formalName: "AD Czerniawski"
						titledName: "Assistant Director Czerniawski"
						genome: 'human
						gender: 'genderFemale
						}

					gordievsky: {
						id: 'gordievsky
						fullName: "Petyr Gordievsky"
						formalName: "AD Gordievsky"
						titledName: "Assistant Director Gordievsky"
						genome: 'human
						gender: 'genderMale
						}

					jones: {
						id: 'jones
						fullName: "Selena Miranda Jones"
						formalName: "AD Jones"
						titledName: "Assistant Director Jones"
						genome: 'human
						gender: 'genderFemale
						}

					leung: {
						id: 'leung
						fullName: "Lien Hua Leung"
						formalName: "AD Leung"
						titledName: "Assistant Director Leung"
						genome: 'human
						gender: 'genderFemale
						}

					price: {
						id: 'price
						fullName: "Arden Price"
						formalName: "AD Price"
						titledName: "Assistant Director Price"
						genome: 'human
						gender: 'genderMale
						}

					penkovsky: {
						id: 'penkovsky
						fullName: "Gideon Penkovsky"
						formalName: "AD Penkovsky"
						titledName: "Assistant Director Penkovsky"
						genome: 'human
						gender: 'genderMale
						}

					reagan: {
						id: 'reagan
						fullName: "Sarah Elizabeth Reagan"
						formalName: "AD Reagan"
						titledName: "Assistant Director Reagan"
						genome: 'human
						gender: 'genderFemale
						}

					sheppard: {
						id: 'sheppard
						fullName: "Matthew Sheppard"
						formalName: "AD Sheppard"
						titledName: "Assistant Director Sheppard"
						genome: 'human
						gender: 'genderMale
						}

					sorge: {
						id: 'sorge
						fullName: "Wolfgang Sorge"
						formalName: "AD Sorge"
						titledName: "Assistant Director Sorge"
						genome: 'human
						gender: 'genderMale
						}

					valerii: {
						id: 'valerii
						fullName: "Jordan Valerii"
						formalName: "AD Valerii"
						titledName: "Assistant Director Valerii"
						genome: 'human
						gender: 'genderFemale
						}

					default: {
						id: 'default
						fullName: "Joe Johnson"
						formalName: "AD Johnson"
						titledName: "Assistant Director Johnson"
						genome: 'human
						gender: 'genderFemale
						}
					}
			</Data>
		</StaticData>
	</Type>

<!-- RESOURCES -->

	<Image UNID="&rsKorolovInsignia;"	bitmap="Resources\KorolovInsignia.jpg" bitmask="Resources\KorolovInsigniaMask.bmp" loadOnUse="true"/>
	<Image UNID="&rsKorolovLogo;"		bitmap="Resources\KorolovLogo.jpg" bitmask="Resources\KorolovLogoMask.bmp" loadOnUse="true"/>
	<Image UNID="&rsKorolovShipping;"	bitmap="Resources\KorolovShipping.jpg" bitmask="Resources\KorolovShippingMask.bmp" loadOnUse="true"/>
	<Image UNID="&rsKorolovShippingConstruction;"	bitmap="Resources\KorolovShippingConstruction.jpg" bitmask="Resources\KorolovShippingConstructionMask.bmp" loadOnUse="true"/>

</TranscendenceModule>
