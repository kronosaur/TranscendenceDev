<?xml version="1.0" encoding="utf-8"?>

<TranscendenceModule>

<!-- Squadron Management UI -->

	<DockScreen unid="&dsRPGSquadron;"
			inherit=		"&dsDockScreenBase;"
			nestedScreen=	"true"
			>
		<Display type="iconList">
			<OnDisplayInit>
				(map (obj@ gPlayerShip 'squadron) theEntry
					(block (
						(shipObj (@ theEntry 'obj))
						)
						{
							title: (@ theEntry 'name)
							icon: (objGetImageDesc shipObj)

							status: (@ theEntry 'status)
							obj: (@ theEntry 'obj)
							objID: (@ theEntry 'objID)
							type: (@ theEntry 'type)
							}
						)
					)
			</OnDisplayInit>
		</Display>

		<Panes>
			<Default>
				<OnPaneInit>
					(block (
						(squadronList (scrGetList gScreen))
						(entry (scrGetListEntry gScreen))
						)
						(switch

							;	If nothing is selected, then we show commands that
							;	apply to the whole squadron.

							(not entry)
								(block (
									(actionPos -1)
									(nextActionPos (lambda () (setq actionPos (+ actionPos 1))))
									(squadronComms (obj@ gPlayerShip 'squadronCommsStatus))

									(deployedCount (map squadronList 'reduceSum theEntry
										(if (= (@ theEntry 'status) 'deployed) 1)
										))

									(addAction (lambda (msgID)
										(scrAddAction gScreen msgID (nextActionPos) Nil
											(lambda ()
												(block ()
													(objSquadronComms gPlayerShip 'squadron msgID)
													(scrExitScreen gScreen 'forceUndock)
													)
												)
											)
										))
									)
									;	Add squadon orders

									(if (find squadronComms 'msgAttackTarget)
										(addAction 'msgAttackTarget)
										)

									(if (find squadronComms 'msgBreakAndAttack)
										(addAction 'msgBreakAndAttack)
										)

									(if (find squadronComms 'msgAttackInFormation)
										(addAction 'msgAttackInFormation)
										)

									(if (find squadronComms 'msgFormUp)
										(addAction 'msgFormUp)
										)

									(if (find squadronComms 'msgSetFormation)
										(block ()
											(addAction 'msgFormationAlpha)
											(addAction 'msgFormationBeta)
											(addAction 'msgFormationGamma)
											)
										)

									(if (find squadronComms 'msgWait)
										(addAction 'msgWait)
										)

									;	Set the descriptor

									(switch
										(gr deployedCount 0)
											(scrSetDescTranslate gScreen 'descSquadronDeployed {
												shipCount: (fmtNoun (scrTranslate gScreen 'nounShip) deployedCount 'countAlways)
												})

										(scrSetDescTranslate gScreen 'descNoSquadron)
										)
									)

							(scrSetDesc gScreen "LATER: " entry)
							)
						)
				</OnPaneInit>
				<Actions>
					<Action id="actionDone" cancel="1">
						(scrExitScreen gScreen)
					</Action>
				</Actions>
			</Default>
		</Panes>

		<Language>
			<Text id="msgAttackInFormation">Order Attack [i]n Formation</Text>
			<Text id="msgAttackTarget">Order [A]ttack Target</Text>
			<Text id="msgBreakAndAttack">Order [B]reak &amp; Attack</Text>
			<Text id="msgFormUp">Order [F]orm Up</Text>
			<Text id="msgFormationAlpha">Order Formation [1] Alpha</Text>
			<Text id="msgFormationBeta">Order Formation [2] Beta</Text>
			<Text id="msgFormationGamma">Order Formation [3] Gamma</Text>
			<Text id="msgWait">Order [W]ait</Text>

			<Text id="descSquadronDeployed">
			
				You have %shipCount% deployed in the system.
				
			</Text>
			<Text id="descNoSquadron">
			
				None of your ships are deployed in this system.
				
			</Text>

			<Text id="nounShip">ship(s)</Text>
		</Language>
	</DockScreen>

</TranscendenceModule>
